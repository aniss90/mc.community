<!DOCTYPE html>  
<html>  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1">  
  <title>Register page</title>  
  <link rel="icon" type="image/x-icon" href="../web/ytlogo.png">  
  <link rel="stylesheet" href="../style/main.css">    
  <style>  
    @font-face {  
      font-family: minecraft;  
      src: url('../font/Minecraft-Default.otf');  
    }  
    @font-face {  
      font-family: minecraft-ten;  
      src: url('../font/Minecraft-Ten.ttf');  
    }  
    @font-face {  
      font-family: minecraft-five;  
      src: url('../font/Minecraft-Five.ttf');  
    }  
  
    .note {  
        background: #222;  
        border: 3px solid #FFBC13;  
        box-shadow: 0px 3px 0px rgba(139, 92, 0, 1);   
        text-align: center;  
        color: white;  
        width: auto;  
        padding: 5px  
    }  
    .note note {  
        background: #FFBC13;  
        color: black;  
        border: 1px solid goldenrod;  
        padding: 5px;  
        font-weight: bold;  
        height: 24px;   
    }  
    p {  
      color: #FFFFFF  
    }  
    .note button {  
        background: #FFBC13;  
        color: black;  
        border: 1px solid goldenrod;  
        padding: 5px;  
        font-weight: bold;  
        height: 24px;   
    }  
    .password-container {  
      position: relative;  
      margin: 10px 0;  
    }
    
    .toggle-password {
      position: absolute;
      margin-top: 11px;
      transform: translateY(-50%);
      transform: translateX(-150%);
      cursor: pointer;
      user-select: none;
      opacity: 0.7;
    }
    
    .toggle-password:hover {
      opacity: 1;
    }
    
    .input-group {
      position: relative;
    }
    
    .input-group input {
      outline: none;
      font-size: 16px;
    }
    
    .input-group label {
      position: absolute;
      top: 12px;
      left: 20%;
      color: #989898;
      font-family: minecraft;
      transition: all 0.4s;
      pointer-events: none;
      background-color: transparent;
      padding: 0 5px;
    }
    
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -10px;
      border-radius: 10px;
      left: 20%;
      font-size: 14px;
      background-color: rgba(38, 38, 38);
      color: #999999;
    }
    
    /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    .register-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 50px;
      padding: 20px;
    }
    
    .register-box {
      flex: 1;
      max-width: 400px;
    }
    
    .register-image {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .register-image img {
      max-width: 100%;
      height: auto;
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      .register-container {
        flex-direction: column;
        gap: 20px;
      }
      
      .register-image {
        order: 2;
        margin-top: 20px;
      }
      
      .register-box {
        order: 1;
        width: 100%;
      }
    }
    /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© */
.input-group input.valid {
  border: 2px solid #4CAF50 !important; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© */
  box-shadow: 0 2px 0 rgba(27, 160, 0, 1);
}

.input-group input.invalid {
  border: 2px solid #f44336 !important; /* Ø£Ø­Ù…Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© */
  box-shadow: 0 2px 0 rgba(160, 0, 0, 1);
}

.input-group input {
  transition: border 0.3s ease;
  border: 2px solid #313131D1 !important; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
}
.sticky-header.sticky {
  position: fixed;
  top: 0;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0.9; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
} 
.header {
  background-color: #222222;
  padding: 10px 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  
  /* Ø§Ø­ØªÙØ¸ Ø¨Ø¨Ø§Ù‚ÙŠ Ø®ØµØ§Ø¦Øµ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
}
     .sticky-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  width: 100%;
  
}
  /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© ØªØ´Ø¨Ù‡ÙÙŠØ³Ø¨ÙˆÙƒ */
  .profile-upload-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }
  
  .profile-image-label {
    cursor: pointer;
    position: relative;
  }
  
  .profile-image-preview {
    width: 150px;
    height: 150px;
    border-radius: 25px;
    overflow: hidden;
    border: 2px solid #727272;
    background-color: #F5F5F500;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.3s;
  }
  
  .profile-image-preview:hover {
    border-color: #CDCDCD; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù…Ø´Ø§Ø¨Ù‡ Ù„ÙÙŠØ³Ø¨ÙˆÙƒ */
  }
  
  .profile-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .upload-icon {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: #474747;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    border: 2px solid #BFBFBF;
  }
  


  </style> 
</head>  
<body>  
<div class="sticky-header"> 
  <div class="header"> register
  <img src="../icons/crafting.gif" height="20"> 
    <button class="back" id="backButton" type="button" onclick="goBack()"></button>
  </div>
</div>
  <div class="content">
    <div class="register-container">
      <div class="register-box">  
        <form id="loginForm">  
          
          <div class="description">
          <div class="title">register box <img src="../icons/gif_test-83efe.gif" height="15"> </div>Fill all fields correctly.
          
          <!-- Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± -->
          <div class="profile-upload-container">
            <label for="profileImage" class="profile-image-label">
              <div class="profile-image-preview" id="profilePreview">
                <img id="previewImage" src="../icons/player-head-128-052ba.png" alt="Profile Preview">
                <div class="upload-icon">+</div>
              </div>
            </label>
            <input type="file" id="profileImage" accept="image/*" style="display: none;">
          </div>
          
          <div class="input-group">
            <input type="text" id="username" placeholder=" " required>  
            <label for="username">Username</label>
            <span class="icon"></span>
          </div>
        
          <div class="password-container">
            <div class="input-group password-container">
              <input type="password" id="password" placeholder="" required>
              <label for="password">Password</label>
              <span class="toggle-password">ï¸ğŸ™‰</span> 
            </div>
          </div>
          
          <div class="input-group">
            <input type="email" id="email" placeholder=" " required>  
            <label for="email">Your email</label>
            <span class="icon"></span>
          </div>
          <br>   
          </div>
        <div> 
          <div class="description"> Click the button to save you're account information.
            <div class="button">   
              <button type="button" id="whiteButton"> Register <img src="../icons/add-player@0.5x.icon-2f437.png" height="15"></button>  
            </div>  
          </div>
        </div>
       </form>
      </div>
      <div class="register-image">
        <div class="description"> 
      <img src="../icons/no-worlds-yet-art-446b1.png" alt="Register Image">
      </div>
      </div>
    </div>
  </div>    
  

<script>
  window.onload = function() {
  const emailField = document.getElementById("email");
  const usernameField = document.getElementById("username");
  
  const savedEmail = localStorage.getItem("googleEmailForRegister");
  
  if (savedEmail) {
    emailField.value = savedEmail;
    usernameField.value = savedEmail.split('@')[0];
    localStorage.removeItem("googleEmailForRegister");
  }
};
</script>
<script type="module">
  import { db } from '../scripts/main.js';
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
  
  // Ø¹Ù†Ø§ØµØ± DOM
  const togglePassword = document.querySelector('.toggle-password');
  const passwordInput = document.getElementById('password');
  const usernameInput = document.getElementById('username');
  const emailInput = document.getElementById('email');
  const profileImageInput = document.getElementById('profileImage');
  const previewImage = document.getElementById('previewImage');
  const registerButton = document.getElementById('whiteButton');
  
  // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©
  function validateUsername(username) {
    return username.length >= 3 && /^[a-zA-Z0-9_]+$/.test(username);
  }
  
  function validatePassword(password) {
    return password.length >= 6;
  }
  
  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
  function convertImageToBase64(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
      callback(e.target.result);
    };
    reader.onerror = function(error) {
      console.error('Error converting image:', error);
      callback(null);
    };
    reader.readAsDataURL(file);
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  function updateRegisterButton() {
    const isUsernameValid = validateUsername(usernameInput.value.trim());
    const isPasswordValid = validatePassword(passwordInput.value.trim());
    const isEmailValid = validateEmail(emailInput.value.trim());
    
    registerButton.disabled = !(isUsernameValid && isPasswordValid && isEmailValid);
  }
  
profileImageInput.addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    if (file.size > 2 * 1024 * 1024) {
      alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
      this.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});
  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
  togglePassword.addEventListener('click', function() {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.textContent = type === 'password' ? 'ï¸ğŸ™ˆ' : 'ï¸ğŸ™‰';
  });
  
  usernameInput.addEventListener('input', function() {
    this.classList.toggle('valid', validateUsername(this.value));
    this.classList.toggle('invalid', !validateUsername(this.value));
    updateRegisterButton();
  });
  
  passwordInput.addEventListener('input', function() {
    this.classList.toggle('valid', validatePassword(this.value));
    this.classList.toggle('invalid', !validatePassword(this.value));
    updateRegisterButton();
  });
  
  emailInput.addEventListener('input', function() {
    this.classList.toggle('valid', validateEmail(this.value));
    this.classList.toggle('invalid', !validateEmail(this.value));
    updateRegisterButton();
  });
  
  // Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
  registerButton.addEventListener('click', async function() {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const email = emailInput.value.trim();
    const profileImage = profileImageInput.files[0];
let photoURL = '';
let photoBase64 = '';

// Ø¥Ø°Ø§ ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
if (profileImage) {
  const base64String = await new Promise((resolve) => {
    convertImageToBase64(profileImage, resolve);
  });
  
  if (base64String) {
    photoURL = base64String;
    photoBase64 = base64String.split(',')[1];
  }
}
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const isUsernameValid = validateUsername(username);
    const isPasswordValid = validatePassword(password);
    const isEmailValid = validateEmail(email);
    
    if (!isUsernameValid || !isPasswordValid || !isEmailValid) {
      alert('Please fill in all fields correctlyğŸ’¡\nÙ…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© ØµØ­ÙŠØ­Ø© ğŸ’¡', 'error');
      return;
    }
    
    try {
      const userDocRef = doc(db, 'users', username);
      const userDoc = await getDoc(userDocRef);
      
      if (userDoc.exists()) {
        alert('Username already exists âŒ', 'error');
        return;
      }
      
      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      const userData = {
  password,
  email,
  points: 0,
  fallTokens: 0,
  status: 'online',
  hasRated: false,
  notification: { read: true },
  photoURL: '',
  photoBase64: '', 
  lastSeenMessages: {}
  
};
      // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©
      if (profileImage) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        const base64String = await new Promise((resolve) => {
          convertImageToBase64(profileImage, resolve);
        });
        
        if (base64String) {
          userData.photoURL = base64String; // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙƒØ±Ø§Ø¨Ø· Ù…Ø¤Ù‚Øª
          userData.photoBase64 = base64String.split(',')[1]; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù… ÙÙ‚Ø·
        }
      }
      
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
      await setDoc(userDocRef, userData);
      
      localStorage.setItem('activeUser', username);
      alert(`Account created successfully âœ…, welcome ${username}.âœ¨`, 'success');
      
      setTimeout(() => {
        window.location.href = 'general.html';
      }, 500);
      
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred. Please try again.', 'error');
    }
  });
</script>
    <script>
window.addEventListener('scroll', function() {
  const header = document.querySelector('.sticky-header');
  if (window.scrollY > 0) {
    header.classList.add('sticky');
  } else {
    header.classList.remove('sticky');
  }
});
</script>
  <script>
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/'; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù…ÙˆÙ‚Ø¹Ùƒ
      }
    }
  </script>
</body>   
</html>