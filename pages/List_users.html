<!DOCTYPE html>  <html lang="ar">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  <link rel="stylesheet" href="../style/main.css" />  
  <title>Users list</title>  
  <style>  
    @font-face {  
      font-family: minecraft;  
      src: url('../font/Minecraft-Default.otf');  
    }  
    @font-face {  
      font-family: minecraft-ten;  
      src: url('../font/Minecraft-Ten.ttf');  
    }  
    @font-face {  
      font-family: minecraft-five;  
      src: url('../font/Minecraft-Five.ttf');  
    }  
    h2 { color: #333; }  
    table { width: 50%; margin: 20px auto; border-collapse: collapse; background: white; }  
    th, td { padding: 10px; border: 1px solid #ddd; }  
    th { background: #3498db; color: white; }  
    tbody.link {  
        color: #0088FF;  
        font-family: minecraft-five;  
    }  
    .note {    
        background: #222222;    
        border: 3px solid #FFBC13;    
        box-shadow: 0px 3px 0px rgba(139, 92, 0, 1);     
        text-align: center;    
        color: white;    
        width: auto;    
        padding: 5px    
    }    
    .note note {    
        background: #FFBC13;    
        color: black;    
        border: 1px solid goldenrod;    
        padding: 5px;    
        font-weight: bold;    
        height: 24px;     
    }    
    p {    
        color: #FFFFFF    
    }    
    .note button {    
        background: #FFBC13;    
        color: black;    
        border: 1px solid goldenrod;    
        padding: 5px;    
        font-weight: bold;    
        height: 24px;     
    }    
    table {  
        width: 99%;  
        max-width: 97%;  
        height: auto;  
        background-color: #222222;  
        color: white;  
        border-radius: 10px;  
        margin: 20px auto;  
        border-collapse: collapse;  
        border-bottom: 3px solid #737373;  
        border-left: 3px solid #737373;  
        border-right: 3px solid #737373;  
    }   th {  
    background-color: #FFFFFF;  
    color: black;  
    padding: 10px;  
}  

td {  
    background-color: #4D4D4D;  
    color: white;  
    padding: 10px;  
    border: 1px solid #ddd;  
}  
td a {  
    color: #FFFFFF;  
    font-weight: bold;  
    text-decoration: none;  
}  

td a:hover {  
    color: #3EB038;  
    text-decoration: underline;  
}  

td strong {  
    color: #00FF00;  
}  

th, td {  
    border: none;
    text-align: left;
}  
  
/* Search box styles */  
.search-container {  
    margin: 20px auto;  
    width: 50%;  
}  
  
#searchInput {  
    width: 100%;  
    padding: 12px 20px;  
    margin: 8px 0;  
    box-sizing: border-box;  
    box-shadow: 0px 3px 0px rgba(139, 92, 0, 1);    
    border: 2px solid #FFBC13;  
    
    background-color: #222222;  
    color: white;  
    font-size: 13px;  
    background-image: url('../imag/Search-c8b13.png');  
background-repeat: no-repeat;  
background-position: 10px center;  
background-size: 15px;  
}  
  
#searchInput:focus {  
    outline: none;  
    border-color: #FFD700;  
}  
  
.no-results {  
    color: #FF5555;  
    padding: 10px;  
    font-weight: bold;  
}  
.points{  
        text-shadow:0px 1px 0px #3A2700;  
}  
  
.new-message-indicator {  
display: inline-block;  
background-color: #008805;  
color: white;  
text-shadow: 0 1px 0 #040404;  
border-radius: 40%;  
width: 20px;  
height: 20px;  
text-align: center;  
font-size: 12px;  
margin-right: 5px;  
font-family: minecraft-five;  
}   

/* Layout for wide screens */  
@media screen and (min-width: 768px) {  
    .content-wrapper {  
        display: flex;  
        flex-direction: row;  
        justify-content: space-between;  
        align-items: flex-start;  
    }  
    .left-content {  
        width: 55%;  
        padding-right: 20px;  
    }  
    .right-image {  
        flex: 1;  
        max-width: 100%;  
  height: auto;  
  position: sticky;        
  display: flex;  
  justify-content: center;  
  align-items: center;  
  flex-direction: column;  
    }  
    table {  
        width: 100%;  
        max-width: 100%;  
    }  
    .search-container {  
        width: 100%;  
    }  
      
    /* Top Users Styles */  
    .top-users-container {  
        background-color: #22222200;  
        border: 2px solid #3D3D3D;  
          
        padding: 15px;  
        margin-bottom: 20px;  
        width: 80%;  
        text-align: center;  
          
    }  
      
    .top-users-title {  
        color: #FFBC13;  
        font-size: 18px;  
        margin-bottom: 10px;  
        font-weight: bold;  
    }  
      
    .top-user {  
        display: flex;  
        justify-content: space-between;  
        align-items: center;  
        padding: 6px;  
        margin: 5px 0;  
        background-color: #333333;  
        
    }  
      
    .top-user.rank-1 {  
        background-color: #FFD700;  
        border: 2px solid #FFED8C;  
        box-shadow: 0 2px 0 #9F8600;  
        color: black;  
        font-weight: bold;  
    }  
      
    .top-user.rank-2 {  
        background-color: #C0C0C0;  
        border: 2px solid #D9D9D9;  
        box-shadow: 0 2px 0 #838383;  
        color: black;  
    }  
      
    .top-user.rank-3 {  
        background-color: #CD7F32;  
        border: 2px solid #E9A664;  
        box-shadow: 0 2px 0 #8C4A09;  
        color: black;  
    }  
      
    .top-user-rank {  
        font-weight: bold;  
        margin-right: 10px;  
    }  
      
    .top-user-name {  
        flex-grow: 1;  
        text-align: left;  
    }  
      
    .top-user-points {  
        font-family: minecraft-five;  
    }  
}

.sticky-header {
position: sticky;
top: 0;
z-index: 1000;
width: 100%;

}

.header {
background-color: #222222;
padding: 10px 0;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
/* احتفظ بباقي خصائص التصميم الحالية */
}

.back {
position: absolute;
top: 50%;
left: 15px;
transform: translateY(-50%);
z-index: 1001;
}
.sticky-header.sticky {
position: fixed;
top: 0;
animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
from { opacity: 0.9; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
.user-cell {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  border-radius: 50%;
  width: 35px;
  height: 35px;
  object-fit: cover;
  border: 0.3px solid #999999;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.user-info {
  display: flex;
  flex-direction: column;
}

.username {
  font-weight: bold;
  
}
span.username{
  color: #1CC535;
}
.unread-badge {
  margin-left: 5px;
}

</style>

</head>  
<body>  
  <div class="sticky-header">     <div class="header">  <button class="back" id="backButton" type="button" onclick="goBack()"></button> User list <img src="../imag/friends-9e435.png" height="20"></div>  
  </div>  
  <div class="content">  
    <div class="content-wrapper">  
      <div class="left-content">  
        <div class="description">  
          <div class="button">  
            <div class="note">  
              <note>What's new?! <img src="../imag/WarningGlyph.png" height="12" /></note>  
              <br />  
              <p>If you want to chating with a user, click on his name and it will take you to the chanting page.</p>  
              إذا كنت تريد التواصل مع مستخدم ما، انقر على اسمه وسوف يأخذك إلى صفحة التواصل.  
            </div>  
          </div>  <div class="search-container">  
        <input type="text" id="searchInput" placeholder="Search for users..." onkeyup="searchUsers()" />  
      </div>  

      <table>  
        <thead>  
          <tr>  
            <th>Username <img src="../imag/player-head-128-052ba.png" height="12" /></th>  
            <th>Coins <img src="../new_emojis/Alot_of_coins.gif" alt="Coin" height="12" /></th>  
          </tr>  
        </thead>  
        <tbody id="userList">  
          <tr><td colspan="2"><img src="../imag/loading_spinner.gif" height="20" /></td></tr>  
        </tbody>  
      </table>  
    </div>  
  </div>  
  <div class="description">   
  <div class="right-image">  
    <div id="topUsersContainer" class="top-users-container" style="display: none;">        <div class="description">   
      <div class="top-users-title">Top Users <img src="../new_emojis/Top1.gif" height="16"></div>  
      <div id="topUsersList"></div>  
    </div>  
    </div>  
    <img src="../imag/Sign-in_Prompts_Launch Animated-fdbda.gif" width="40%" />  
  </div>  
  </div>  
</div>

  </div>  
    <script type="module">  
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";  
      import { getFirestore, collection, onSnapshot, doc, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";  const firebaseConfig = {  
    apiKey: "AIzaSyBf-HKpI4G5p6E0xP1OHGLxtDTGwE_0gg0",  
    authDomain: "minecraft-community-4fd3d.firebaseapp.com",  
    projectId: "minecraft-community-4fd3d",  
    storageBucket: "minecraft-community-4fd3d.appspot.com",  
    messagingSenderId: "550140131027",  
    appId: "1:550140131027:web:a5186726cf5372e138c626",  
    measurementId: "G-F18SFG2LMZ"  
  };  

  const app = initializeApp(firebaseConfig);  
  const db = getFirestore(app);  

  function formatPoints(num) {  
    if (num >= 1_000_000_000_000) return (num / 1_000_000_000_000).toFixed(1).replace(/\.0$/, '') + 'T';  
    if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1).replace(/\.0$/, '') + 'B';  
    if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';  
    if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'k';  
    return num.toString();  
  }  

  const userList = document.getElementById("userList");  
  const topUsersContainer = document.getElementById("topUsersContainer");  
  const topUsersList = document.getElementById("topUsersList");  
  let allUsers = [];  

  function displayTopUsers(users) {  
    // استبعاد المستخدم "Anis" إذا كان موجوداً  
    let filteredUsers = users.filter(user => user.username !== "Anis");  
      
    // إذا كان "Anis" هو الأول، نأخذ الثلاثة الأوائل بعد استبعاده  
    // وإلا نأخذ الثلاثة الأوائل بعد الاستبعاد  
    let topUsers = filteredUsers.slice(0, 3);  
      
    // إذا كان "Anis" كان الأول، نضيف الرابع ليحل محله  
    if (users.length > 3 && users[0].username === "Anis") {  
      topUsers = [filteredUsers[0], filteredUsers[1], filteredUsers[2]];  
    }  
      
    topUsersList.innerHTML = '';  
      
    topUsers.forEach((user, index) => {  
      const rankClass = `rank-${index + 1}`;  
      const formattedPoints = formatPoints(user.points);  
        
      const userElement = document.createElement('div');  
      userElement.className = `top-user ${rankClass}`;  
      userElement.innerHTML = `  
        <span class="top-user-rank">#${index + 1}</span>  
        <span class="top-user-name">${user.username}</span>  
        <span class="top-user-points">${formattedPoints} <img src="../new_emojis/Alot_of_coins.gif" alt="Coin" height="12"></span>  
      `;  
        
      topUsersList.appendChild(userElement);  
    });  
      
    // عرض العنصر فقط إذا كان لدينا مستخدمين  
    if (topUsers.length > 0) {  
      topUsersContainer.style.display = 'block';  
    }  
  }  

  onSnapshot(collection(db, "users"), (snapshot) => {  
    userList.innerHTML = '';  

    const activeUser = localStorage.getItem("activeUser");  
    if (!activeUser) {  
      alert("You must log in first!");  
      window.location.href = "login.html";  
      return;  
    }  

    if (snapshot.empty) {  
      userList.innerHTML += "<tr><td colspan='2'>No users found</td></tr>";  
    } else {  
      allUsers = [];  
      snapshot.forEach((doc) => {  
        const username = doc.id;  
        const points = doc.data().points || 0;  
        allUsers.push({ username, points });  
      });  

      // فرز المستخدمين حسب عدد النقاط من الأكبر إلى الأصغر  
      allUsers.sort((a, b) => b.points - a.points);  

      // عرض المتصدرين في الشريط الجانبي للشاشات العريضة  
      if (window.matchMedia("(min-width: 768px)").matches) {  
        displayTopUsers(allUsers);  
      }  

      // عرض المستخدمين بالترتيب  
      allUsers.forEach((user) => {  
        displayUser(user.username, user.points, activeUser);  
      });  
    }  
  });  

function displayUser(username, points, activeUser, photoURL) {
  const formatted = formatPoints(points);
  const unreadCount = unreadMessages[username] || 0;
  
  let unreadBadge = '';
  if (unreadCount > 0) {
    const displayCount = unreadCount > 9 ? '9+' : unreadCount;
    unreadBadge = `<span class="new-message-indicator unread-badge">${displayCount}</span>`;
  }
  
  const userImage = photoURL || '../imag/player-head-128-052ba.png';
  
  const row = (username === activeUser) ?
    `<tr class="user-row">
        <td class="user-cell">
          <img src="${userImage}" alt="${username}" class="user-avatar">
          <div class="user-info">
            <span class="username">${username}</span>
          </div>
          ${unreadBadge}
        </td>
        <td class="points"><img src="../new_emojis/coinss_gif.gif" alt="Coin" height="12"> ${formatted}</td>
      </tr>` :
    `<tr class="user-row">
        <td class="user-cell">
          <img src="${userImage}" alt="${username}" class="user-avatar">
          <div class="user-info">
            <a href="chat_beta.html?user=${encodeURIComponent(username)}" class="username">${username}</a>
          </div>
          ${unreadBadge}
        </td>
        <td class="points"><img src="../new_emojis/coinss_gif.gif" alt="Coin" height="12"> ${formatted}</td>
      </tr>`;
  
  userList.innerHTML += row;
}

  let unreadMessages = {};  
  const activeUser = localStorage.getItem("activeUser");  
    
  if (activeUser) {  
onSnapshot(collection(db, "users"), (snapshot) => {
  userList.innerHTML = '';
  
  const activeUser = localStorage.getItem("activeUser");
  if (!activeUser) {
    alert("You must log in first!");
    window.location.href = "login.html";
    return;
  }
  
  if (snapshot.empty) {
    userList.innerHTML += "<tr><td colspan='2'>No users found</td></tr>";
  } else {
    allUsers = [];
    snapshot.forEach((doc) => {
      const username = doc.id;
      const points = doc.data().points || 0;
      const photoURL = doc.data().photoURL; // جلب صورة المستخدم
      allUsers.push({ username, points, photoURL });
    });
    
    // فرز المستخدمين حسب عدد النقاط من الأكبر إلى الأصغر
    allUsers.sort((a, b) => b.points - a.points);
    
    // عرض المتصدرين في الشريط الجانبي للشاشات العريضة
    if (window.matchMedia("(min-width: 768px)").matches) {
      displayTopUsers(allUsers);
    }
    
    // عرض المستخدمين بالترتيب
    allUsers.forEach((user) => {
      displayUser(user.username, user.points, activeUser, user.photoURL);
    });
  }
});
  }  
    
  // تحديث عرض المتصدرين عند تغيير حجم الشاشة  
  window.addEventListener('resize', function() {  
    if (window.matchMedia("(min-width: 768px)").matches && allUsers.length > 0) {  
      displayTopUsers(allUsers);  
    } else {  
      topUsersContainer.style.display = 'none';  
    }  
  });  
</script>  

<script>  
  function goBack() {  
    if (window.history.length > 1) {  
      window.history.back();  
    } else {  
      window.location.href = '/';  
    }  
  }  

  function searchUsers() {  
    const input = document.getElementById("searchInput");  
    const filter = input.value.toUpperCase();  
    const rows = document.getElementsByClassName("user-row");  
    let found = false;  

    for (let i = 0; i < rows.length; i++) {  
      const username = rows[i].getElementsByTagName("td")[0].textContent ||  
        rows[i].getElementsByTagName("td")[0].innerText;  

      if (username.toUpperCase().indexOf(filter) > -1) {  
        rows[i].style.display = "";  
        found = true;  
      } else {  
        rows[i].style.display = "none";  
      }  
    }  

    const noResults = document.querySelector(".no-results");  
    if (!found) {  
      if (!noResults) {  
        const msg = document.createElement("div");  
        msg.className = "no-results";  
        msg.textContent = "No users found matching your search.";  
        userList.appendChild(msg);  
      }  
    } else if (noResults) {  
      noResults.remove();  
    }  
  }  
  let scrollTimeout;

window.addEventListener('scroll', function() {
clearTimeout(scrollTimeout);
scrollTimeout = setTimeout(function() {
const header = document.querySelector('.sticky-header');
if (window.scrollY > 10) { // تغيير من 0 إلى 10 لتحسين الأداء
header.classList.add('sticky');
} else {
header.classList.remove('sticky');
}
}, 15); // تأخير 15 مللي ثانية لتحسين الأداء
});

</script>

  <script>  
window.addEventListener('scroll', function() {  
  const header = document.querySelector('.sticky-header');  
  if (window.scrollY > 0) {  
    header.classList.add('sticky');  
  } else {  
    header.classList.remove('sticky');  
  }  
});  
</script>  </body>  
</html>  
