<!DOCTYPE html>  <html lang="ar">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  <link rel="stylesheet" href="../style/main.css" />  
  <link rel="stylesheet" href="../style/tags.css" />  
  <title>Users list</title>  
  <style>  
    @font-face {  
      font-family: minecraft;  
      src: url('../font/Minecraft-Default.otf');  
    }  
    @font-face {  
      font-family: minecraft-ten;  
      src: url('../font/Minecraft-Ten.ttf');  
    }  
    @font-face {  
      font-family: minecraft-five;  
      src: url('../font/Minecraft-Five.ttf');  
    }  
    h2 { color: #333; }  
    table { width: 50%; margin: 20px auto; border-collapse: collapse; background: white; }  
    th, td { padding: 10px; border: 1px solid #ddd; }  
    th { background: #3498db; color: white; }  
    tbody.link {  
        color: #0088FF;  
        font-family: minecraft-five;  
    }  table {  
    width: 100%;  
    max-width: 100%;  
    height: auto;  
    background-color: #22222200;  
    color: white;  
    border-radius: 10px;  
    margin: 20px auto;  
    border: none;  
}  
  
th {  
  background-color: #6A6A6A00;  
  color: #C1C1C1;  
  text-shadow: 0 2px 4px #484848;  
  padding: 10px;  
}  

td {  
  background-color: #4D4D4D00;  
  color: white;  
  padding: 10px;  
  border: 1px solid #ddd;  
}  
  
td a {  
  color: #FFFFFF;  
  font-weight: bold;  
  text-decoration: none;  
}  

td a:hover {  
  color: #BBBBBB;  
  text-decoration: underline;  
}  

td strong {  
  color: #FFFFFF;  
}  

th, td {  
  border: none;  
  text-align: left;  
}  
  
.user-row {  
  cursor: pointer;  
  transition: all 0.5s;  
  -webkit-tap-highlight-color: transparent;  
  tap-highlight-color: transparent;  
}  

.user-row:hover {  
  background-color: rgba(185, 185, 185, 0.07) !important;  
}  
  
/* Search box styles */  
.search-container {  
  margin: 20px auto;  
  width: 100%;  
}  
  
#searchInput {  
  width: 100%;  
  padding: 12px 20px;  
  box-sizing: border-box;  
  box-shadow: 0px 3px 0px rgba(105, 105, 105, 1);  
  border: 2px solid #C7C7C7;  
  background-color: #222222;  
  border-radius: 24px;  
  color: white;  
  font-size: 13px;  
  background-image: url('../icons/Search-c8b13.png');  
  background-repeat: no-repeat;  
  background-position: 10px center;  
  background-size: 15px;  
  transition: all 0.5s;  
}  
  
#searchInput:focus {  
  outline: none;  
  border-color: #FFFFFF;  
  box-shadow: 4px 0px 15px #FFFFFF69;  
}  
  
.no-results {  
  color: #FF5555;  
  padding: 10px;  
  font-weight: bold;  
}  
  
.points {  
  text-shadow: 0px 1px 0px #3A2700;  
}  
  
.new-message-indicator {  
  display: inline-block;  
  background-color: #008805;  
  color: white;  
  text-shadow: 0 1px 0 #040404;  
  border-radius: 40%;  
  width: 20px;  
  height: 20px;  
  text-align: center;  
  font-size: 12px;  
  margin-right: 5px;  
  font-family: minecraft-five;  
}  
  
/* Layout for wide screens */  
@media screen and (min-width: 768px) {  
  .content-wrapper {  
    display: flex;  
    flex-direction: row;  
    justify-content: space-between;  
    align-items: flex-start;  
  }  
  .left-content {  
    width: 55%;  
    padding-right: 20px;  
  }  
  .right-image {  
    flex: 1;  
    max-width: 100%;  
    height: auto;  
    position: sticky;  
    display: flex;  
    justify-content: center;  
    align-items: center;  
    flex-direction: column;  
  }  
  table {  
    width: 100%;  
    max-width: 100%;  
  }  
  .search-container {  
    width: 100%;  
  }  
    .user-avatar {
  border-radius: 50%;
  width: 40px;
  height: 40px;
  object-fit: cover;
  border: 2px solid transparent;
  box-shadow: 
    0 0 0 2px #4A4A4A, /* Outer border */
    0 2px 5px rgba(0, 0, 0, 0.3),
    0 0 20px rgba(255, 255, 255, 0.1) inset;
  transition: all 0.3s ease;
  position: relative;
  z-index: 1;
}

.user-avatar::before {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border-radius: 50%;
  background: linear-gradient(135deg, #FFD700, #FF8C00, #FF4500);
  z-index: -1;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.user-row:hover .user-avatar {
  border-color: #FFD700;
  box-shadow: 
    0 0 0 2px #4A4A4A,
    0 4px 8px rgba(0, 0, 0, 0.4),
    0 0 30px rgba(255, 215, 0, 0.2) inset;
  transform: scale(1.05);
}

.user-row:hover .user-avatar::before {
  opacity: 0.7;
}

/* تنسيقات خاصة للأفتار في قائمة أفضل المستخدمين */
.top-user .user-avatar {
  width: 30px;
  height: 30px;
  border: 2px solid rgba(255, 255, 255, 0.5);
}

.top-user.rank-1 .user-avatar {
  border-color: #FFD700;
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
}

.top-user.rank-2 .user-avatar {
  border-color: #C0C0C0;
  box-shadow: 0 0 10px rgba(192, 192, 192, 0.7);
}

.top-user.rank-3 .user-avatar {
  border-color: #CD7F32;
  box-shadow: 0 0 10px rgba(205, 127, 50, 0.7);
}
  /* Top Users Styles */  
  .top-users-container {  
    background-color: #22222200;  
    border: 2px solid #3D3D3D;  
    padding: 15px;  
    margin-bottom: 20px;  
    width: 80%;  
    text-align: center;  
  }  
    
  .top-users-title {  
    color: #FFBC13;  
    font-size: 18px;  
    margin-bottom: 10px;  
    font-weight: bold;  
  }  
    
  .top-user {  
    display: flex;  
    justify-content: space-between;  
    align-items: center;  
    padding: 6px;  
    margin: 5px 0;  
    background-color: #333333;  
  }  
    
  .top-user.rank-1 {  
    background-color: #FFD700;  
    border: 2px solid #FFED8C;  
    box-shadow: 0 2px 0 #9F8600;  
    color: black;  
    font-weight: bold;  
  }  
    
  .top-user.rank-2 {  
    background-color: #C0C0C0;  
    border: 2px solid #D9D9D9;  
    box-shadow: 0 2px 0 #838383;  
    color: black;  
  }  
    
  .top-user.rank-3 {  
    background-color: #CD7F32;  
    border: 2px solid #E9A664;  
    box-shadow: 0 2px 0 #8C4A09;  
    color: black;  
  }  
    
  .top-user-rank {  
    font-weight: bold;  
    margin-right: 10px;  
  }  
    
  .top-user-name {  
    flex-grow: 1;  
    text-align: left;  
  }  
    
  .top-user-points {  
    font-family: minecraft-five;  
  }  
}  

.sticky-header {  
  position: sticky;  
  top: 0;  
  z-index: 1000;  
  width: 100%;  
}  

.header {  
  background-color: #222222;  
  padding: 10px 0;  
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);  
}  

.back {  
  position: absolute;  
  top: 50%;  
  left: 15px;  
  transform: translateY(-50%);  
  z-index: 1001;  
}  
  
.sticky-header.sticky {  
  position: fixed;  
  top: 0;  
  animation: fadeIn 0.3s ease-in-out;  
}  

@keyframes fadeIn {  
  from { opacity: 0.9; transform: translateY(-10px); }  
  to { opacity: 1; transform: translateY(0); }  
}  
  
.user-cell {  
  display: flex;  
  align-items: center;  
  gap: 10px;  
}  

.user-avatar {  
  border-radius: 50%;  
  width: 35px;  
  height: 35px;  
  object-fit: cover;  
  border: 0.3px solid #999999;  
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);  
}  

.user-info {  
  display: flex;  
  flex-direction: column;  
}  

.username {  
  font-weight: bold;  
}  
.user-info {
display: flex;
flex-direction: column;
}

.more-tags {
background-color: #666;
color: white;
font-family: minecraft-five;
font-size: 10px;
padding: 2px 6px;
border-radius: 3px;
text-shadow: 0 1px 0px rgba(0, 0, 0, 0);
}  
span.username {  
  color: #FFFFFF;  
}  
  
.unread-badge {  
  margin-left: 5px;  
}  
  
/* تنسيق عمود Fall Tokens */  
.fall-tokens {  
  color: #E29A2B;  
  font-weight: bold;  
}  

/* تنسيق عرض Fall Tokens لأفضل المستخدمين */  
.top-user-falltokens {  
  color: #000000;  
  margin-left: 10px;  
  font-weight: bold;  
}  

/* تعديل عرض الجدول */  
table {  
  width: 100%;  
}  

th, td {  
  padding: 8px;  
  text-align: left;  
}  
  
.current-user {  
  cursor: default !important;  
}  

.current-user:hover {  
  background-color: transparent !important;  
}  
  
/* تنسيقات الـ Tags */  
.user-tags {  
  gap: 5px;  
  padding-left: 2px;  
}  

.tag {  
  font-family: minecraft-five;  
  font-size: 10px;  
  padding: 2px 6px;  
  border-radius: 3px;  
  text-shadow: 0 1px 0px rgba(0, 0, 0, 0.3);  
  margin-right: 4px;  
  
}

  </style>  
  
</head>  
<body>  
  <div class="sticky-header">  
    <div class="header">  
      <button class="back" id="backButton" type="button" onclick="goBack()"></button>  
      Users list  
      <img src="../icons/friends-9e435.png" height="20"></div>  
    </div>  
  </div>    <div class="content">  
    <div class="content-wrapper">  
      <div class="left-content">  
        <div class="description">  
          <div class="search-container">  
            <input type="text" id="searchInput" placeholder="Search for users..." onkeyup="searchUsers()" />  
          </div>  <table>  
        <thead>  
          <tr>  
          </tr>  
        </thead>  
        <tbody id="userList">  
          <tr><td colspan="3"><img src="../icons/loading_spinner.gif" height="20" /></td></tr>  
        </tbody>  
      </table>  
    </div>  
  </div>  
    
  <div class="description">  
    <div class="right-image">  
      <div id="topUsersContainer" class="top-users-container" style="display: none;">  
        <div class="description">  
          <div class="top-users-title">Top Users <img src="../icons/Top1.gif" height="16"></div>  
          <div id="topUsersList"></div>  
        </div>  
      </div>  
      <img src="../icons/Sign-in_Prompts_Launch Animated-fdbda.gif" width="40%" />  
    </div>  
  </div>  
</div>

  </div>    <script>  
    // دالة مبسطة لحفظ واسترجاع الصور باستخدام الرابط كمفتاح  
    function cacheImages() {  
      const images = document.querySelectorAll('img, [style*="background-image"]');  
        
      images.forEach(element => {  
        let imageUrl;  
          
        if (element.tagName === 'IMG') {  
          imageUrl = element.src;  
        } else {  
          const style = window.getComputedStyle(element);  
          imageUrl = style.backgroundImage.replace(/url['"]?(.*?)['"]?/i, '$1');  
        }  
          
        if (!imageUrl || imageUrl.startsWith('data:')) return;  
          
        const cachedImage = localStorage.getItem(imageUrl);  
          
        if (cachedImage) {  
          if (element.tagName === 'IMG') {  
            element.src = cachedImage;  
          } else {  
            element.style.backgroundImage = `url(${cachedImage})`;  
          }  
        } else {  
          fetch(imageUrl)  
            .then(response => response.blob())  
            .then(blob => {  
              const reader = new FileReader();  
              reader.onload = function() {  
                localStorage.setItem(imageUrl, this.result);  
                if (element.tagName === 'IMG') {  
                  element.src = this.result;  
                } else {  
                  element.style.backgroundImage = `url(${this.result})`;  
                }  
              };  
              reader.readAsDataURL(blob);  
            })  
            .catch(error => {  
              console.error('Error caching image:', error);  
            });  
        }  
      });  
    }  
      
    window.addEventListener('DOMContentLoaded', cacheImages);  
  </script>    <script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";  
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";  
      import { getTagName } from '../scripts/tags.js';
      
      
    const firebaseConfig = {  
      apiKey: "AIzaSyBf-HKpI4G5p6E0xP1OHGLxtDTGwE_0gg0",  
      authDomain: "minecraft-community-4fd3d.firebaseapp.com",  
      projectId: "minecraft-community-4fd3d",  
      storageBucket: "minecraft-community-4fd3d.appspot.com",  
      messagingSenderId: "550140131027",  
      appId: "1:550140131027:web:a5186726cf5372e138c626",  
      measurementId: "G-F18SFG2LMZ"  
    };  
      
    const app = initializeApp(firebaseConfig);  
    const db = getFirestore(app);  
      
    function formatPoints(num) {  
      if (num >= 1_000_000_000_000) return (num / 1_000_000_000_000).toFixed(1).replace(/\.0$/, '') + 'T';  
      if (num >= 1_000_000_000) return (num / 1_000_000_000).toFixed(1).replace(/\.0$/, '') + 'B';  
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';  
      if (num >= 1_000) return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'k';  
      return num.toString();  
    }  
      
      
    const userList = document.getElementById("userList");  
    const topUsersContainer = document.getElementById("topUsersContainer");  
    const topUsersList = document.getElementById("topUsersList");  
    let allUsers = [];  
      
    function displayTopUsers(users) {  
      let filteredUsers = users.filter(user => user.username !== "Anis");  
      let topUsers = filteredUsers.slice(0, 3);  
        
      if (users.length > 3 && users[0].username === "Anis") {  
        topUsers = [filteredUsers[0], filteredUsers[1], filteredUsers[2]];  
      }  
        
      topUsersList.innerHTML = '';  
        
      topUsers.forEach((user, index) => {  
        const rankClass = `rank-${index + 1}`;  
        const formattedPoints = formatPoints(user.points);  
        const formattedFallTokens = formatPoints(user.fallTokens || 0);  
          
        const userElement = document.createElement('div');  
        userElement.className = `top-user ${rankClass}`;  
        userElement.innerHTML = `  
          <span class="top-user-rank">#${index + 1}</span>  
          <span class="top-user-name">${user.username}</span>  
          <span class="top-user-points">${formattedPoints} <img src="../icons/Alot_of_coins.gif" alt="Coin" height="12"></span>  
          <span class="top-user-falltokens">${formattedFallTokens} <img src="../icons/fall_token.png" alt="Fall Token" height="12"></span>  
        `;  
          
        topUsersList.appendChild(userElement);  
      });  
        
      if (topUsers.length > 0) {  
        topUsersContainer.style.display = 'block';  
      }  
    }  
      
    function displayUser(username, points, fallTokens, activeUser, photoURL, tags = []) {  
      const formattedPoints = formatPoints(points);  
      const formattedFallTokens = formatPoints(fallTokens || 0);  
      const userImage = photoURL || '../icons/player-head-128-052ba.png';  
        
      const isActiveUser = username === activeUser;  
      const rowClass = isActiveUser ? 'user-row current-user' : 'user-row';  
        
      let tagsHTML = '';
if (tags && tags.length > 0) {
   const visibleTags = tags.slice(0, 3);
   const extraCount = tags.length - 3;
   
   tagsHTML = '<div class="user-tags">';
   visibleTags.forEach(tag => {
      tagsHTML += `<span class="tag tag-${tag}"></span>`;
   });
   
   if (extraCount > 0) {
      tagsHTML += `<span class="tag more-tags">+${extraCount}</span>`;
   }
   
   tagsHTML += '</div>';
}
        
      const row = `<tr class="${rowClass}" ${!isActiveUser ? `onclick="window.location.href='profile.html?user=${encodeURIComponent(username)}'"` : ''}>  
        <td class="user-cell">  
          <img src="${userImage}" alt="${username}" class="user-avatar">  
          <div class="user-info">  
            <span class="username">${username}${tagsHTML}</span>  
          </div>  
        </td>  
        <td class="points"><img src="../icons/coinss_gif.gif" alt="Coin" height="12"> ${formattedPoints}</td>  
        <td class="fall-tokens"><img src="../icons/fall_token.png" alt="Fall Token" height="12"> ${formattedFallTokens}</td>  
      </tr>`;  
        
      userList.innerHTML += row;  
    }  
      
    onSnapshot(collection(db, "users"), (snapshot) => {  
      userList.innerHTML = '';  
        
      const activeUser = localStorage.getItem("activeUser");  
      if (!activeUser) {  
        alert("يجب تسجيل الدخول أولاً!");  
        window.location.href = "login.html";  
        return;  
      }  
        
      if (snapshot.empty) {  
        userList.innerHTML += "<tr><td colspan='3'>لا يوجد مستخدمين</td></tr>";  
      } else {  
        allUsers = [];  
        snapshot.forEach((doc) => {  
          const username = doc.id;  
          const points = doc.data().points || 0;  
          const fallTokens = doc.data().fallTokens || 0;  
          const photoURL = doc.data().photoURL;  
          const tags = doc.data().areatags || [];  
          allUsers.push({ username, points, fallTokens, photoURL, tags });  
        });  
          
        allUsers.sort((a, b) => b.points - a.points);  
          
        if (window.matchMedia("(min-width: 768px)").matches) {  
          displayTopUsers(allUsers);  
        }  
          
        allUsers.forEach((user) => {  
          displayUser(user.username, user.points, user.fallTokens, activeUser, user.photoURL, user.tags);  
        });  
      }  
    });  
      
    window.addEventListener('resize', function() {  
      if (window.matchMedia("(min-width: 768px)").matches && allUsers.length > 0) {  
        displayTopUsers(allUsers);  
      } else {  
        topUsersContainer.style.display = 'none';  
      }  
    });  
  </script>    <script>  
    function goBack() {  
      if (window.history.length > 1) {  
        window.history.back();  
      } else {  
        window.location.href = '/';  
      }  
    }  
      
    function searchUsers() {  
      const input = document.getElementById("searchInput");  
      const filter = input.value.toUpperCase();  
      const rows = document.getElementsByClassName("user-row");  
      let found = false;  
        
      for (let i = 0; i < rows.length; i++) {  
        const username = rows[i].getElementsByTagName("td")[0].textContent ||  
          rows[i].getElementsByTagName("td")[0].innerText;  
          
        if (username.toUpperCase().indexOf(filter) > -1) {  
          rows[i].style.display = "";  
          found = true;  
        } else {  
          rows[i].style.display = "none";  
        }  
          
        rows[i].onclick = function() {  
          const username = this.querySelector('.username').textContent;  
          window.location.href = `profile.html?user=${encodeURIComponent(username)}`;  
        };  
      }  
        
      const noResults = document.querySelector(".no-results");  
      if (!found) {  
        if (!noResults) {  
          const msg = document.createElement("div");  
          msg.className = "no-results";  
          msg.textContent = "لا توجد نتائج مطابقة للبحث";  
          userList.appendChild(msg);  
        }  
      } else if (noResults) {  
        noResults.remove();  
      }  
    }  
      
    let scrollTimeout;  
    window.addEventListener('scroll', function() {  
      clearTimeout(scrollTimeout);  
      scrollTimeout = setTimeout(function() {  
        const header = document.querySelector('.sticky-header');  
        if (window.scrollY > 10) {  
          header.classList.add('sticky');  
        } else {  
          header.classList.remove('sticky');  
        }  
      }, 15);  
    });  
  </script>  </body>  
</html>  
