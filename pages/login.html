<!DOCTYPE html>  
<html>    
<head>    
  <meta charset="UTF-8">    
  <meta name="viewport" content="width=device-width, initial-scale=1">    
  <link rel="stylesheet" href="../style/main.css">    
  <link rel="icon" type="image/x-icon" href="../web/ytlogo.png">    
  <title>Login Page</title>    
  <style>    
    @font-face {    
      font-family: minecraft;    
      src: url('../font/Minecraft-Default.otf');    
    }    
    @font-face {    
      font-family: minecraft-ten;    
      src: url('../font/Minecraft-Ten.ttf');    
    }    
    @font-face {    
      font-family: minecraft-five;    
      src: url('../font/Minecraft-Five.ttf');    
    }   
    @font-face {    
      font-family: MinecraftFive-Regular;    
      src: url('../font/MinecraftFive-Regular.ttf');    
    }    
    #greenButton{
      font-family: MinecraftFive-Regular;
    }
    .password-container {    
      position: relative;    
      margin: 10px 0;    
    }  
    .toggle-password {  
      position: absolute;  
      margin-top: 11px;  
      transform: translateY(-50%);  
      transform: translateX(-150%);  
      cursor: pointer;  
      user-select: none;  
      opacity: 0.7;  
    }  
    .toggle-password:hover {
      opacity: 1;
    }
    .input-group {
      position: relative;
    }
    .input-group input {
      outline: none;
      font-size: 16px;
    }
    .input-group label {
      position: absolute;
      top: 12px;
      left: 20%;
      color: #484848;
      font-family: minecraft;
      transition: all 0.3s;
      pointer-events: none;
      background-color: transparent;
      padding: 0 5px;
    }
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -10px;
      border-radius: 10px;
      left: 20%;
      font-size: 14px;
      background-color: rgba(38, 38, 38);
      color: #959595;
    }
    
    .login-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 50px;
      padding: 20px;
    }
    
    .login-box {
      flex: 1;
      max-width: 400px;
    }
    
    .login-image {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .login-image img {
      max-width: 100%;
      height: auto;
    }
    
    /* Custom Alert Styles */
    .custom-alert {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .custom-alert-content {
      background-color: #262626;
      border: 3px solid #E0BA31;
      padding: 20px;
      width: 80%;
      border-radius: 2px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0px 3px 0px rgba(224, 155, 0, 1);
      animation: fadeIn 0.3s;
      font-family: 'MinecraftFive-Regular', sans-serif;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .custom-alert-title {
      color: gold;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .custom-alert-message {
      color: #e0e0e0;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .custom-alert-button {
      transition: background-color 0.5s;
      height: auto;
      width: 100%;
      border: 2px solid #FFFB8D;
      background-color: #FFFB00;
      text-shadow: 1px 1px 2px #B9B600;
      box-shadow: 0px 3px 0px rgba(224, 155, 0, 1);
      font-size: 16px;
      cursor: pointer;
      position: relative;
      display: inline-block;
      padding: 10px;
      color: #000000;
      margin: auto;
      transition: all 0.3s;
    }

    .custom-alert-button:hover {
      background-color: #9D5F00;
      transform: scale(1.05);
    }

    .custom-alert-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 15px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-15px);}
      60% {transform: translateY(-7px);}
    }
    
    /* Social Login Buttons - Small Version */
    .social-login-container {
      margin-top: 20px;
      text-align: center;
    }
    
    .social-login-title {
      color: #959595;
      font-family: 'MinecraftFive-Regular', sans-serif;
      margin-bottom: 10px;
    }
    
    .social-login-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .social-btn {
      width: 40px;
      height: 40px;
      border-radius: 0%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid #C5C5C5;
      box-shadow:0 2px 0 #9A9A9A; 
      
    }
    
    .social-btn:hover {
      transform: scale(1.1);
    }
    
    .social-btn img {
      width: 20px;
      height: 20px;
    }
    
    .social-btn.google {
      background-color: #FFFFFF;
    }
    
    .guest-btn {
      margin-top: 15px;
      background-color: #2A9A2F;
      border: 2px solid #47C24C;
      box-shadow: 0 2px 0 #009F06;
      color: white;
    
      padding: 8px 15px;
      font-family: 'MinecraftFive-Regular', sans-serif;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .guest-btn:hover {
      background-color: #137517;
    }
    
    @media (max-width: 768px) {
      .login-container {
        flex-direction: column;
        gap: 20px;
      }
      
      .login-image {
        order: 2;
        margin-top: 20px;
      }
      
      .login-box {
        order: 1;
        width: 100%;
      }
      
      .custom-alert-content {
        width: 90%;
      }
    }
  </style>
</head>    
<body>      
  <div class="header">  
    <button class="back" id="backButton" type="button" onclick="goBack()"></button>   
    Login <img src="../imag/gif_test-83efe.gif" height="30">  
  </div>  
  
  <div class="content">  
    <div class="login-container">
      <div class="login-box">    
       <div class="title"> login box </div>
        <form id="loginForm">    
          <div class="input-group"> 
            <input type="text" id="username" placeholder=" " required>  
            <label for="username">Username</label>  
          <br>  
          <div class="input-group password-container">  
            <input type="password" id="password" placeholder=" " required>  
            <label for="password">Password</label>  
            <span class="toggle-password">üôà</span>  
          </div>  
          <br>  
          <a href="forget.html" class="link">forget password ?</a>  
          <br>      
          <div class="description">    
            <div class="button">     
              <button type="submit" id="greenButton"> Login <img src="../imag/enter-icon-31b5a.png" height="15"></button>    
            </div>     
          </div>
          </div>

          <div>     
            <div class="description">    
              üî∏Don't have an account? <a href="Register.html" class="link">Register  <img src="../imag/IconAddPlayerWhite-c25a0.png" height="12px"></a>     
            </div>    
          </div>    
        </form>
        
        <!-- Social Login Buttons - Small Version -->
        <div class="social-login-container">
          <div class="social-login-title">Or sign in with:</div>
          <div class="social-login-buttons">
            <button class="social-btn google" id="googleLogin">
              <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google G Logo">
            </button>
          </div>
          <button class="guest-btn" id="guestLogin">Dev.Guest</button>
        </div>
      </div>
      
      <div class="login-image">
        <img src="../imag/tutorial_end-fbdd6.png" alt="Login Image">
      </div>
    </div>
  </div>
  
  <!-- Custom Alert -->
  <div id="customAlert" class="custom-alert">
    <div class="custom-alert-content">
      <img src="../Emojis/donut.png" class="custom-alert-icon" alt="Success">
      <div class="custom-alert-title" id="alertTitle">Welcome Back!</div>
      <div class="custom-alert-message" id="alertMessage"></div>
      <button class="custom-alert-button" id="alertButton">Continue</button>
    </div>
  </div>
  
  <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ (Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑÿßŸã) -->  
  <button id="logoutButton" style="display: none; margin-top: 20px;">Log out</button>    
  
  <script type="module">    
    import { db, auth } from '../scripts/main.js'; // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµÿØŸäÿ± auth ŸÖŸÜ main.js
    import { 
      doc, 
      getDoc, 
      setDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    
    import {
      GoogleAuthProvider,
      signInWithPopup,
      signInAnonymously,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
      
    const togglePassword = document.querySelector('.toggle-password');    
    const passwordInput = document.getElementById('password');    
    
    togglePassword.addEventListener('click', function () {    
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';    
      passwordInput.setAttribute('type', type);    
      this.textContent = type === 'password' ? 'Ô∏èüôâ' :'Ô∏èÔ∏èüôà';  
    });    
    
    const logoutButton = document.getElementById("logoutButton");    
    
    // ‚úÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑŸãÿß ÿ®ÿßŸÑŸÅÿπŸÑÿå Ÿäÿ™ŸÖ ŸÜŸÇŸÑŸá ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©    
    window.onload = function () {    
      let activeUser = localStorage.getItem("activeUser");    
      if (activeUser) {    
        window.location.href = "general.html"; // ŸÜŸÇŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß    
      }    
    };    
    
    // Custom Alert Function
    function showCustomAlert(title, message) {
      const alertElement = document.getElementById('customAlert');
      const alertTitle = document.getElementById('alertTitle');
      const alertMessage = document.getElementById('alertMessage');
      const alertButton = document.getElementById('alertButton');
      
      alertTitle.textContent = title;
      alertMessage.textContent = message;
      
      alertElement.style.display = 'flex';
      
      alertButton.onclick = function() {
        alertElement.style.display = 'none';
        window.location.href = 'general.html';
      };
    }
    
    // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸàŸÅÿ± ÿ¨Ÿàÿ¨ŸÑ
    const googleProvider = new GoogleAuthProvider();
    
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿ¨Ÿàÿ¨ŸÑ
    document.getElementById('googleLogin').addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        const user = result.user;
        
        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
        const userDocRef = doc(db, 'users', user.uid);
        await setDoc(userDocRef, {
          uid: user.uid,
          displayName: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          provider: 'google',
          createdAt: serverTimestamp(),
          isGuest: false,
          lastLogin: serverTimestamp()
        }, { merge: true });
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('activeUser', user.uid);
        
        showCustomAlert(
          `Welcome ${user.displayName || 'User'}!`, 
          `You have successfully logged in with Google. Enjoy!`
        );
      } catch (error) {
        console.error('Google login error:', error);
        alert('Failed to login with Google. Please try again.');
      }
    });
    
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉÿ∂ŸäŸÅ
    document.getElementById('guestLogin').addEventListener('click', async () => {
      try {
        const result = await signInAnonymously(auth);
        const user = result.user;
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßÿ≥ŸÖ ÿ∂ŸäŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿä
        const guestName = "Guest_" + Math.random().toString(36).substring(2, 8);
        
        // ÿ≠ÿ≥ÿßÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© (30 ŸäŸàŸÖ ŸÖŸÜ ÿßŸÑÿ¢ŸÜ)
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 30);
        
        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
        const userDocRef = doc(db, 'users', user.uid);
        await setDoc(userDocRef, {
          uid: user.uid,
          displayName: guestName,
          provider: 'guest',
          createdAt: serverTimestamp(),
          isGuest: true,
          expiryDate: expiryDate,
          lastLogin: serverTimestamp()
        }, { merge: true });
        
        // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
        localStorage.setItem('activeUser', user.uid);
        
        showCustomAlert(
          `Welcome ${guestName}!`, 
          `You are playing as a guest. Your account will expire in 30 days.`
        );
        
        // ÿ¨ÿØŸàŸÑÿ© ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ÿπÿØ 30 ŸäŸàŸÖ
        setTimeout(async () => {
          try {
            await deleteDoc(userDocRef);
            console.log(`Guest account ${guestName} deleted after 30 days`);
          } catch (err) {
            console.error('Error deleting guest account:', err);
          }
        }, 30 * 24 * 60 * 60 * 1000); // 30 ŸäŸàŸÖ ÿ®ÿßŸÑŸÖŸäŸÑŸä ÿ´ÿßŸÜŸäÿ©
        
      } catch (error) {
        console.error('Guest login error:', error);
        alert('Failed to login as guest. Please try again.');
      }
    });
    
    // ÿØÿßŸÑÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ∂ŸäŸÅÿ© ÿßŸÑŸÖŸÜÿ™ŸáŸäÿ©
    async function deleteExpiredGuestAccounts() {
      try {
        const now = new Date();
        const q = query(
          collection(db, 'users'),
          where('isGuest', '==', true),
          where('expiryDate', '<=', now)
        );
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(async (doc) => {
          await deleteDoc(doc.ref);
          console.log(`Deleted expired guest account: ${doc.id}`);
        });
      } catch (error) {
        console.error('Error deleting expired guest accounts:', error);
      }
    }
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿ∞ŸÅ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    deleteExpiredGuestAccounts();
    
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿπÿßÿØŸä  
    document.getElementById('loginForm').addEventListener('submit', async function (e) {     
      e.preventDefault();      
      const username = document.getElementById('username').value.trim();      
      const password = document.getElementById('password').value.trim();      
      if (!username || !password) {      
        alert('Please fill out all fields');      
        return;      
      }      
      try {      
        const userDocRef = doc(db, 'users', username);      
        const userDoc = await getDoc(userDocRef);      
        if (userDoc.exists() && userDoc.data().password === password) {      
          localStorage.setItem('activeUser', username);      
          showCustomAlert(  
            `Welcome back ${username}!!`,   
            `You have successfully logged in ‚úÖ. Enjoy !`  
          );  
        } else {      
          alert('Invalid username or password!');      
        }      
      } catch (error) {      
        console.error('Error during login:', error);      
        alert('An error occurred while logging in, try again please.');      
      }      
    });      
      
    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨      
    logoutButton.addEventListener("click", function () {      
      signOut(auth).then(() => {
        localStorage.removeItem("activeUser");      
        alert("You have logged out successfully.");      
        window.location.reload();
      }).catch((error) => {
        console.error('Logout error:', error);
        alert("Logout failed. Please try again.");
      });      
    });    
  </script>         
  
  <script>    
    function goBack() {  
      if (window.history.length > 1) {  
        window.history.back();  
      } else {  
        window.location.href = '/';
      }  
    }  
  </script>    
</body>  
</html>