<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دردشة مع المستخدم</title>
    <link rel="stylesheet" href="../style/main.css">
    <style>
        @font-face {
            font-family: minecraft;
            src: url('../font/Minecraft-Default.otf');
        }
        @font-face {
            font-family: minecraft-ten;
            src: url('../font/Minecraft-Ten.ttf');
        }
        @font-face {
            font-family: minecraft-five;
            src: url('../font/Minecraft-Five.ttf');
        }
        body { font-family: Arial, sans-serif; text-align: center; }
        h2 { color: #333; }
    
        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }
        
        #send-btn, #upload-btn {
            padding: 15px;
            height: 50px;
            color: white;
            border: none;
            cursor: pointer;
            background-color: #2C8014;
            color: #FFFFFF;
            border: 2px solid #4f913c;
            box-shadow: 0px 3px 0px #1d4d13;
            font-size: 16px;
            display: inline-block;
            margin:auto;
        }

        #send-btn:hover, #upload-btn:hover {
            background-color: #45a049;
        } 

        h2 {
            color: #FFFFFF; 
        }
        
        .message {
            max-width: 60%;
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            word-wrap: break-word;
            display: inline-block;
        }

        .myMessage {
            align-self: flex-end;
            background-color: #2C8014;
            border: 2px solid #4f913c;
            box-shadow: 0px 3px 0px #1d4d13;
            font-size: 16px;
            color: white;
            text-align: right;
            margin-left: auto;
            border-radius: 15px 15px 0px 15px;
        }

        .otherMessage {
            align-self: flex-start;
            background-color: #FFFFFF;
            border: 2px solid #DCDCDC;
            box-shadow: 0px 3px 0px rgba(111, 111, 111, 1);
            font-size: 16px;
            color: black;
            text-align: left;
            margin-right: auto;
            border-radius: 15px 15px 15px 0px;
        }
        
        #chatUser {
            font-family: minecraft-ten; 
            font-size: 35px;
        }

        #chatBox {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            height: calc(100vh - 140px);
            padding-bottom: 15px;
            overflow-x: hidden;
        }

        .message {
            max-width: 70%;
            padding: 10px;
            border-radius: 15px;
            margin: 5px;
            display: inline-block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        } 

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0px;
            background-color: #303233;
            z-index: 10;
            display: flex;
            flex: 1;
        }
        
        div.header {
            position: ;
        }
        
        #message-input {
            width: 100%;
            min-height: 40px;
            max-height: 150px;
            resize: none;
            overflow: hidden;
            font-size: 16px;
            padding: 10px;
        }
        
        .blur-background .message:not(.selected-message) {
            filter: blur(4px);
        }

        .message-options {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 100;
        }

        .option-btn {
            padding: 6px 12px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }

        .option-btn.copy {
            background-color: green;
            color: white;
        }

        .option-btn.delete {
            background-color: red;
            color: white;
        }
    </style>
</head>
<body>
    <button class="back" id="backButton" type="button" onclick="goBack()"></button>
    <div class="header"> <span id="chatUser"></span> <img src="../imag/player-head-128-052ba.png" height="25">
    </div> 
    <div id="chatBox"></div>
    <div id="chat-box"></div>
    <div class="input-container">
        <textarea id="message-input" rows="1" maxlength="200" placeholder="Write something..."></textarea>
        <input type="file" id="image-input" style="display: none;">
        <button id="upload-btn">img <img src="../imag/gallery-10d21.png" alt="Coin" height="13"></button>
        <button id="send-btn">send</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf-HKpI4G5p6E0xP1OHGLxtDTGwE_0gg0",
            authDomain: "minecraft-community-4fd3d.firebaseapp.com",
            projectId: "minecraft-community-4fd3d",
            storageBucket: "minecraft-community-4fd3d.firebasestorage.app",
            messagingSenderId: "550140131027",
            appId: "1:550140131027:web:a5186726cf5372e138c626",
            measurementId: "G-F18SFG2LMZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const activeUser = localStorage.getItem("activeUser");
        const urlParams = new URLSearchParams(window.location.search);
        const receiver = urlParams.get("user");

        if (!activeUser || !receiver) {
            alert("يجب تسجيل الدخول واختيار مستخدم للدردشة!");
            window.location.href = "List_beta.html";
        }

        document.getElementById("chatUser").innerText = receiver;

        const messagesRef = collection(db, "messages");
        const chatBox = document.getElementById("chatBox");

        const messagesQuery = query(
            messagesRef,
            where("sender", "in", [activeUser, receiver]),
            where("receiver", "in", [activeUser, receiver]),
            orderBy("timestamp")
        );

        // متغير لتخزين آخر رسالة معروضة
        let lastDisplayedMessageId = null;

        onSnapshot(messagesQuery, (snapshot) => {
            let hasNewMessage = false;
            chatBox.innerHTML = "";

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const isMyMessage = (data.sender === activeUser);

                const messageElement = document.createElement("div");
                messageElement.classList.add("message", isMyMessage ? "myMessage" : "otherMessage");
                messageElement.setAttribute("data-id", docSnap.id);

                // تحقق إذا كانت هذه الرسالة جديدة ولم يتم عرضها من قبل
                if (!lastDisplayedMessageId && docSnap.id) {
                    lastDisplayedMessageId = docSnap.id;
                } else if (docSnap.id !== lastDisplayedMessageId && !isMyMessage) {
                    hasNewMessage = true;
                    lastDisplayedMessageId = docSnap.id;
                }

                const escapedMessage = escapeHTML(data.message);
                messageElement.innerHTML = `<strong>${data.sender}:</strong> ${escapedMessage}`;
                chatBox.appendChild(messageElement);
            });

            chatBox.scrollTop = chatBox.scrollHeight;

            // عرض إشعار إذا كانت هناك رسالة جديدة من المرسل الآخر
            if (hasNewMessage && document.hidden) {
                const lastMessage = snapshot.docs[snapshot.docs.length - 1].data();
                showNotification(lastMessage.sender, lastMessage.message);
            }
        });

        function escapeHTML(text) {
            return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function showNotification(sender, message) {
            if (Notification.permission === "granted") {
                new Notification(`رسالة جديدة من ${sender}`, {
                    body: message,
                    icon: "../imag/player-head-128-052ba.png"
                });

                // تشغيل صوت الإشعار إذا كان متاحًا
                const sound = new Audio("../sounds/Notify.mp3");
                sound.play().catch(e => console.log("لا يمكن تشغيل الصوت:", e));
            }
        }

        // طلب الإذن لعرض الإشعارات عند تحميل الصفحة
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("تم السماح بالإشعارات");
                }
            });
        }

        // تتبع إذا كانت الصفحة غير مرئية (في الخلفية)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // الصفحة أصبحت في الخلفية
                console.log("الصفحة في الخلفية، جاهزة لتلقي الإشعارات");
            }
        });

        const messageInput = document.getElementById("message-input");

        messageInput.addEventListener("input", () => {
            messageInput.style.height = "auto";
            messageInput.style.height = (messageInput.scrollHeight) + "px";
        });

        async function sendMessage() {
            let messageText = messageInput.value.trim();

            if (messageText === "") {
                alert("لا يمكن إرسال رسالة فارغة!");
                return;
            }

            const maxChars = 200;
            if (messageText.length > maxChars) {  
                messageText = messageText.substring(0, maxChars);
                alert("لا يمكنك إرسال رسالة تحتوي على أكثر من 200 حرفًا!");
            }

            try {
                await addDoc(messagesRef, {
                    sender: activeUser,
                    receiver: receiver,
                    message: messageText,
                    timestamp: new Date()
                });

                messageInput.value = "";
                messageInput.style.height = "40px";
            } catch (error) {
                console.error("حدث خطأ أثناء إرسال الرسالة:", error);
            }
        }

        const sendButton = document.getElementById("send-btn");
        sendButton.addEventListener("click", sendMessage);

        document.addEventListener("DOMContentLoaded", () => {
            const chatBox = document.getElementById("chatBox");
            let holdTimeout;
            let isHolding = false;

            chatBox.addEventListener("mousedown", handleLongPress);
            chatBox.addEventListener("touchstart", handleLongPress);
            chatBox.addEventListener("mouseup", cancelHold);
            chatBox.addEventListener("touchend", cancelHold);
            chatBox.addEventListener("mouseleave", cancelHold);

            function handleLongPress(event) {
                if (!event.target.classList.contains("message")) return;

                let messageElement = event.target;
                let messageText = messageElement.innerText;

                isHolding = true;

                holdTimeout = setTimeout(() => {
                    if (isHolding) {
                        showOptions(messageElement, messageText);
                    }
                }, 500);
            }

            function cancelHold() {
                isHolding = false;
                clearTimeout(holdTimeout);
            }

            function showOptions(messageElement, messageText) {
                closeOptions();

                document.body.classList.add("blur-background");
                messageElement.classList.add("selected-message");

                let optionsContainer = document.createElement("div");
                optionsContainer.classList.add("message-options");

                let copyBtn = document.createElement("button");
                copyBtn.innerText = "نسخ";
                copyBtn.classList.add("option-btn", "copy");
                copyBtn.addEventListener("click", () => {
                    navigator.clipboard.writeText(messageText);
                    alert("تم نسخ الرسالة!");
                    closeOptions();
                });

                let deleteBtn = document.createElement("button");
                deleteBtn.innerText = "حذف";
                deleteBtn.classList.add("option-btn", "delete");
                deleteBtn.style.display = messageElement.classList.contains("myMessage") ? "block" : "none";
                deleteBtn.addEventListener("click", async () => {
                    if (confirm("هل تريد حذف هذه الرسالة؟")) {
                        const docId = messageElement.getAttribute("data-id");
                        await deleteMessage(docId, messageElement);
                    }
                });

                optionsContainer.appendChild(copyBtn);
                optionsContainer.appendChild(deleteBtn);
                messageElement.appendChild(optionsContainer);
                optionsContainer.style.display = "flex";

                setTimeout(() => {
                    document.addEventListener("click", closeOptions);
                }, 100);
            }

            function closeOptions() {
                let options = document.querySelector(".message-options");
                if (options) options.remove();
                document.body.classList.remove("blur-background");

                let selectedMessage = document.querySelector(".selected-message");
                if (selectedMessage) selectedMessage.classList.remove("selected-message");

                document.removeEventListener("click", closeOptions);
            }

            async function deleteMessage(docId, messageElement) {
                try {
                    const messageRef = doc(db, "messages", docId);
                    await deleteDoc(messageRef);
                    messageElement.remove();
                    console.log("تم حذف الرسالة بنجاح!");
                } catch (error) {
                    console.error("فشل في حذف الرسالة:", error);
                }
            }
        });
    </script>
    <script>
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>