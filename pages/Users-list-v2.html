<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="../web/mcco-logo.png">
  <link rel="stylesheet" href="../style/main.css">
  <link rel="stylesheet" href="../style/tags.css">
  <title>Users List</title>
  <style>
    @font-face {
      font-family: minecraft;
      src: url('../font/Minecraft-Default.otf');
    }
    @font-face {
      font-family: minecraft-ten;
      src: url('../font/Minecraft-Ten.ttf');
    }
    @font-face {
      font-family: minecraft-five;
      src: url('../font/Minecraft-Five.ttf');
    }
    @font-face {
      font-family: MinecraftFive-Regular;
      src: url('../font/MinecraftFive-Regular.ttf');
    }

    .container {
      margin: 0 auto;
    }

    .users-section {
      background-color: #262626;
      padding: 20px;
      border-radius: 5px;
      border: 2px solid #4a4a4a;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'MinecraftFive-Regular', sans-serif;
      color: #E0BA31;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .users-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .user-card {
      display: flex;
      align-items: center;
      background-color: #3a3a3a;
      padding: 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .user-card:hover {
      background-color: #4a4a4a;
    }

    .user-pic {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      margin-right: 15px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-family: 'MinecraftFive-Regular', sans-serif;
      font-size: 18px;
      color: #fff;
      margin-bottom: 5px;
    }

    .user-handle {
      color: #D9D9D9;
      font-size: 14px;
      font-family: 'minecraft', sans-serif;
    }

    .user-stats {
      display: flex;
      gap: 20px;
      margin-top: 5px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'MinecraftFive-Regular', sans-serif;
      font-size: 16px;
      color: #fff;
    }

    .stat-label {
      color: #959595;
      font-size: 10px;
    }

    #noUsersMessage {
      text-align: center;
      color: #959595;
      font-size: 16px;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #262626;
    }
  </style>
</head>
<body>
  <div class="sticky-header">
    <div class="header">
      <button class="back" id="backButton" type="button" onclick="goBack()"><</button>
      <div style="color: black; font-size: 35px; font-family: Minecraft-ten;">Users List</div>
    </div>
  </div>

  <div class="content">
    <div class="container">
      <div class="users-section">
        <div class="section-title">Available Users</div>
        <div id="noUsersMessage" style="display: none;">No users found.</div>
        <div class="users-list" id="usersList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from '../scripts/main.js';
    import { collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    function formatNumber(num) {
      if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';
      if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
      return num.toString();
    }

    // دالة لعرض قائمة المستخدمين
    function displayUsers(users) {
      const container = document.getElementById('usersList');
      container.innerHTML = '';

      if (users.length === 0) {
        document.getElementById('noUsersMessage').style.display = 'block';
        return;
      }

      document.getElementById('noUsersMessage').style.display = 'none';

      users.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.onclick = () => window.location.href = `selected-user-profile.html?user=${user.id}`;

        const photoURL = user.photoURL || '../icons/player-head-128-052ba.png';

        userCard.innerHTML = `
          <img src="${photoURL}" class="user-pic" alt="Profile Pic">
          <div class="user-info">
            <div class="user-name">${user.displayName || user.username || 'User'}</div>
            <div class="user-handle">@${user.id}</div>
            <div class="user-stats">
              <div class="stat-item">
                <div class="stat-value">${formatNumber(user.points || 0)}</div>
                <div class="stat-label">Coins</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${formatNumber(user.likes || 0)}</div>
                <div class="stat-label">Likes</div>
              </div>
            </div>
          </div>
        `;

        container.appendChild(userCard);
      });
    }

    // تحميل المستخدمين في الوقت الفعلي
    function loadUsers() {
      const usersQuery = query(collection(db, 'users'));
      onSnapshot(usersQuery, (snapshot) => {
        const users = [];
        snapshot.forEach((doc) => {
          users.push({ id: doc.id, ...doc.data() });
        });
        // يمكن ترتيب المستخدمين حسب النقاط أو شيء آخر إذا أردت
        users.sort((a, b) => (b.points || 0) - (a.points || 0)); // ترتيب تنازلي حسب النقاط
        displayUsers(users);
      }, (error) => {
        console.error("Error loading users:", error);
        document.getElementById('noUsersMessage').textContent = 'Error loading users.';
        document.getElementById('noUsersMessage').style.display = 'block';
      });
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', loadUsers);
  </script>

  <script>
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/';
      }
    }
  </script>
</body>
</html>