<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Marketplace</title>  
    <link rel="stylesheet" href="../style/main.css">  
    <link rel="icon" type="png" href="../icons/marketplace-icon-7f96f.png">  
        <script async src="https://www.googletagmanager.com/gtag/js?id=F18SFG2LMZ"></script>  
    <script>  
      window.dataLayer = window.dataLayer || [];  
      function gtag(){dataLayer.push(arguments);}  
      gtag('js', new Date());  
      gtag('config', 'F18SFG2LMZ');  
    </script>  
    <style>  
        @font-face {  
            font-family: minecraft;  
            src: url('../font/Minecraft-Default.otf');  
        }  
        @font-face {  
            font-family: minecraft-ten;  
            src: url('../font/MinecraftTen.ttf');  
        }  
        @font-face {  
            font-family: minecraft-five;  
            src: url('../font/Minecraft-Five.ttf');  
        }  
        
        body {
            overflow-x: hidden;
        }
        
        #points {  
            color: #FFBC13;   
            font-size: 15px;   
        }  

        #welcomeMessage {  
            color: #FFFFFF;   
            font-size: 15px;   
            font-family: minecraft-five;   
        }  

        .shop {  
            display: flex;  
            flex-wrap: wrap;  
            gap: 7px;  
            justify-content: center;  
            padding: 1px;   
            margin-top: 30px;  
        }  

        .shop-item {  
            background: #222;  
            border: 2px solid #FFBC13;  
            border-radius: 2px;  
            text-align: center;  
            color: white;  
            width: auto;  
            padding-left: 5px;  
            padding-right: 5px;  
            padding-top: 5px;  
            position: relative;
            transition: transform 0.2s;
        }  

        .shop-item:hover {
            transform: translateY(-2px);
            z-index: 10;
        }

        .img-shop img {  
            width: auto;  
            height: 50px;  
            border-radius: 5px;
        }  

        .shop-item button {  
            background: #FFBC13;  
            color: black;  
            border: 2px solid #FFCB48;  
            padding: 3px;  
            cursor: pointer;  
            font-weight: bold;  
            height: 24px;  
           margin-left: 3px; 
        }  

        .shop-item button:hover {  
            background: #e6a800;  
            top: 1px;  
            position: relative;  
        }  

        .header {  
            color: #FFD952;   
            text-shadow: 0px 3px 0px #9D6F16;  
        }  

        .description {  
            text-align: center;   
            text-shadow: #A3A3A3;  
        }  

        .item-name {  
            color: #FFFFFF;   
            font-size: auto;  
            text-shadow:0px 1px 0px #000000;  
        }  
.itemPrice {
    color: #FFD952;
    text-shadow: 0px 1px 0px #3A2700;
    font-size: auto;
    animation: colorCycle 2s ease-in-out infinite;
}

@keyframes colorCycle {
    0%   { color: #FFD952; }
    50%  { color: #FFD18A; }
    100% { color: #FFD952; }
} 
        .price-label {  
            color: #FFFFFF;  
        }  

        .loot-boxes {  
            text-align: center;  
            margin-top: 20px;  
        }

        .silverButton:hover {
            border: 2px solid #D3D3D3;
            top: 2px;
            height: auto;
            width: 100%;
            position: relative;
            box-shadow: 5px 0 15px #B6B6B6;
        }

        .silverButton  {
            text-shadow: 1px 1px 0.9px #7A7A7A;
            background-color: #222222;
            color: #FFFFFF;
            height: auto;
            width: 100%;
            border: 2px solid #7B7B7B;
            box-shadow: 0px 3px 0px rgba(26, 26, 26, 1);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 10px;
            margin:auto;
            transition: all 0.5s;
        }

        .purpleButton:hover {
            top: 2px;
            height: auto;
            width: 100%;
            position: relative;
            border: 2px solid #F553FF;
            box-shadow: 5px 0 25px #BC04C7;
        }

        .purpleButton {
            text-shadow: 1px 1px 0.9px rgba(157, 0, 157, 1);
            height: auto;
            width: 100%;
            border: 2px solid #FE26FF;
            border: 2px solid #64046A;
            background-color: #230026;
            box-shadow: 0px 3px 0px rgba(32, 0, 28, 1);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 10px;
            color: #FFFFFF;
            margin: auto;
            transition: all 0.5s;
        }
        
        .goldeButton:hover {
            top: 2px;
            height: auto;
            width: 100%;
            position: relative;
            border: 2px solid #FFD15E;
            box-shadow: 5px 0 18px #BF9837;
        }

        .goldeButton {
            text-shadow: 1px 1px 0.9px rgba(180, 125, 0, 1);
            height: auto;
            width: 100%;
            border: 2px solid #FFFFFF;
            border: 2px solid #8C6A15;
            background-color: #2E2100;
            box-shadow: 0px 3px 0px rgba(43, 30, 0, 1);
            font-size: 16px;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 10px;
            color: #FFFFFF;
            margin: auto;
            transition: all 0.5s;
        }

        /* Tooltip styles */
        .tooltip {
            position: fixed;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #FFFFFF00; 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(90px);
            color: #FFFFFF;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 999;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 2px solid #FFBC13;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            width: 107%;
            max-width: 80vw;
            white-space: normal;
            text-align: left;
            
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        .tooltip img {
            float: left;
            margin-right: 10px;
            margin-bottom: 5px;
            width: auto;
            height: 40px;
            border-radius: 5px;
        }

        .shop-item:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Sell button styles */
        .sellButton {
            background: #FF0000 !important;
            color: white !important;
            border: 2px solid #D84444 !important;
        }

        .sellButton:hover {
            background: #DE1010 !important;
            top: 1px;  
            position: relative;  
        }
        
        span {
            color: blanchedalmond;
            text-shadow: 0 1px 0 #202020;
            font-family: minecraft-five;
        }

        /* أنماط قسم الميزات بنفس ستايل العناصر الأخرى */
        .features-section {
            margin-top: 30px;
            border-top: 2px solid #FFBC13;
            padding-top: 20px;
        }
        
        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
            justify-content: left;
            padding: 1px;
        }
        
        .feature-item {
            background: #222;
            border: 2px solid #4CAF50;
            border-radius: 2px;
            text-align: center;
            color: white;
            width: auto;
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 5px;
            position: relative;
            transition: transform 0.2s;
        }
        
        .feature-item:hover {
            transform: translateY(-2px);
            z-index: 10;
        }
        
        .feature-item.unlocked {
            border-color: #FFBC13;
        }
        
        .feature-img img {
            width: auto;
            height: 50px;
        }
        
        .feature-name {
            color: #FFFFFF;
            font-size: auto;
            text-shadow:0px 1px 0px #000000;
        }
        
        .feature-price {
            color: #4CAF50;
            text-shadow:0px 1px 0px #0A3A0A;
            background: #2E5D2E;
            border: 2px solid #3A7A3A;
            font-size: auto;
            padding: 2px 5px;
            margin: 5px 0;
        }
        
        .feature-item.unlocked .feature-price {
            color: #FFD952;
            background: #916204;
            border: 2px solid #A6730F;
        }
        
        .feature-button {
            background: #4CAF50;
            color: black;
            border: 2px solid #5CBF5C;
            padding: 3px;
            cursor: pointer;
            font-weight: bold;
            height: 24px;
            margin-left: 3px;
        }
        
        .feature-button.unlocked {
            background: #FFBC13;
            border: 2px solid #FFCB48;
        }
        
        .feature-button:hover:not(.unlocked) {
            background: #45a049;
            top: 1px;
            position: relative;
        }
        
        .feature-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #FFBC13;
            color: black;
            padding: 2px 5px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: bold;
            display: none;
        }
        
        .feature-item.unlocked .feature-badge {
            display: block;
        }
        .sticky-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  width: 100%;
  
}

.header {
  background-color: #222222;
  padding: 10px 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  
  /* احتفظ بباقي خصائص التصميم الحالية */
}

.back {
  position: absolute;
  top: 50%;
  left: 15px;
  transform: translateY(-50%);
  z-index: 1001;
}
.sticky-header.sticky {
  position: fixed;
  top: 0;
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0.9; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}  
.back-to-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: none;
  z-index: 999;
  background: #FFBC13;
  color: black;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 20px;
  transition: all 0.3s;
}

.back-to-top:hover {
  transform: translateY(-3px);
} 
h3{
    color: #1DFF00;
    font-family: minecraft-five;
}
#pointsToConvert{
    outline: none;
    background-color: #ECECEC00;
    transform: none;
    width: auto;
    box-shadow: none;
    transition: all 0.5s;
}
#pointsToConvert:hover{
    border: 2px solid #5F5F5F;
    box-shadow: 0 2px 10px #5F5F5F;
}
#convertBtn{
    border: 2px solid #FFBF68;
    background-color: #FFA200;
    color: #FFFFFF;
    box-shadow: 0 2px 0 #B76E0B;
    width: 100%;
    height: auto;
    font-size: 16px;
    padding: 10px;
    text-shadow: 1px 1px 0.9px #9D5B00;
    transition: background-color 0.5s;
}
#convertBtn:hover{
    background-color: #9D5B00;
    box-shadow: none;
    padding: 11px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}
.new-badge {
    position: absolute;
    top:-10px;
    right:-13px;
    width: 18px;
    height: 18px;
                background: url(../icons/icon_new_item.png);
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
    color: white;
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 3px;

    z-index: 1;
}

.shop-item {
    position: relative;
}
.particle {
  position: absolute;
  width: 7px;
  height: 7px;
  background-color: #FFC208;
  
  animation: riseUp 3s ease-out forwards;
  pointer-events: none;
  box-shadow: 2px 1px 13px 2px rgba(255, 194, 8, 0.92);
-webkit-box-shadow: 2px 1px 13px 2px rgba(255, 194, 8, 0.92);
-moz-box-shadow: 2px 1px 13px 2px rgba(255, 194, 8, 0.92);
  z-index: 1;
}

@keyframes riseUp {
  0% {
    transform: translateY(0) scale(1.3);
    opacity: 1;
  }
  100% {
    transform: translateY(-60px) scale(0.5);
    opacity: 0;
  }
}
#header {
width: 100%;
  background-color: #FFFEBDBF;
  backdrop-filter: blur(8px); 
  border: 2px solid #FFC208;
  box-shadow: 0 4px 0 #6D511F;
  transition: all 0.5s;
  color: goldenrod;
  text-shadow: none; 
 text-shadow: 0 2px 0 #946F1A; 
}
    </style>  
</head>  

<body>  
<div class="sticky-header"> 
            <div class="marketplace-container ">
    <div class="header" id="header">    
        <button class="back" id="backButton" type="button" onclick="goBack()"></button>  
        Marketplace
        <img src="../icons/marketplace_new_logo.png"loading="lazy" height="20">
    </div>   
            </div>
</div> 
    <div class="content">   
        <span id="welcomeMessage"></span>  
<div class="points">
  <div class="title">
    your wallet : <span id="points">
      <img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span>
    <span id="points-float" style="display: inline-block; position: relative;"></span><img src="../icons/coinss_gif.gif" loading="lazy" height="15">|
    <span id="fallTokens">
      <img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span>
    <img src="../icons/fall_token.png" alt="Fall Token" height="15">
  </div>
</div>

<div class="description"> 
                <div class="title">Currency Exchange
                </div>
                <img src="../icons/coinss_gif.gif" alt="Coin" height="15">➡️<img src="../icons/fall_token.png" alt="Fall Token" height="15">
            
                    
                    <div class="input-group">
                        <label for="pointsToConvert" style="color: white;">Coins to Convert:</label>
                        <input type="number" id="pointsToConvert" min="1" step="1" placeholder="Enter coins 1×××">
                        <span class="coin-icon"><img src="../icons/coinss_gif.gif" height="15"></span>
                    </div>
                    
                    <div class="conversion-rate">
                    </div>
                    <br> 
                    <div class="result-group">
                        <label style="color: wheat;">You will receive:</label>
                        <span  id="tokensResult" style="color: orange;">0</span> <img src="../icons/fall_token.png" alt="Fall Token" height="15">
                    </div>
                    </br> 
                    <div class="button"> 
                    <button id="convertBtn" class="convert-button">Convert</button>
</div>
</div>
<div class="title"> boxes</div>
<div class="description"> 
buy any box here.
            <div class="loot-boxes">  
                <!-- صناديق loot buttons -->  
                <div class="description">   
                    <div class="title"> silver box <img src="../icons/crate_mythical.png" height="13"></div>   
                    You can get between 1 to 1000 coins.  
                    <button class="silverButton" id="cheapBox" onclick="openLootBox('cheap')">Silver Box (199<img src="../icons/coinss_gif.gif" alt="Coin" height="14">)</button>  
                </div>  
                <div class="description">   
                    <div class="title"> gold box <img src="../icons/crate_rare.png" height="13"></div>   
                    You can get between 99 to 3000 coins.
                    <button class="goldeButton" id="mediumBox" onclick="openLootBox('medium')">Gold Box (2000<img src="../icons/coinss_gif.gif" alt="Coin" height="14">)</button>
                </div>

                <div class="description">   
                    <div class="title">Epic box <img src="../icons/crate_epic.png" height="15"></div>   
                    You can get between 1 to 90k coins.
                    <button class="purpleButton" id="expensiveBox" onclick="openLootBox('expensive')">Epic Box (10.1K <img src="../icons/Alot_of_coins.gif" alt="Coin" height="14">)</button>
                </div>
            </div>
</div>
            <div class="features-section">
                <div class="title">Account Features <img src="../icons/experimental-features-icon-dca93.png" height="15"></div>
                <div class="description">
         Unlock special features for your account!
         <p style="color: lawngreen;">soon.</p>
         <p style="color: lawngreen;">قريبا.</p>
                        <div class="features-list">
                        
                    <!-- سيتم إضافة الميزات هنا بشكل ديناميكي -->
                </div>
                </div>
            </div>
                        
            <div class="title"> items shop <img src="../icons/sparkles_gif.gif" height="15" ></div>
            

                <div class="shop">
                    <!-- سيتم إضافة العناصر هنا بشكل ديناميكي -->

                </div>
            </div>
            
            <!-- قسم الميزات بنفس ستايل العناصر -->
            
        </div>
    </div>
<script>
  const button = document.getElementById('header');
  const container = document.querySelector('.marketplace-container');
  
  function createParticle() {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    
    // توليد موقع عشوائي حول الزر
    const padding = 10;
    const randomX = Math.random() * (button.offsetWidth + padding * 2) - padding;
    const randomY = Math.random() * (button.offsetHeight + padding * 2) - padding;
    
    particle.style.left = `${randomX}px`;
    particle.style.top = `${randomY}px`;
    
    container.appendChild(particle);
    
    // حذف بعد انتهاء الأنميشن
    setTimeout(() => {
      particle.remove();
    }, 3000);
  }
  
  // توليد جزيئات بشكل مستمر
  setInterval(createParticle, 300);
</script>
    <script type="module">  
        import { db } from '../scripts/main.js';   
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";   
  import { shopItems } from './items.js';
        const activeUser = localStorage.getItem('activeUser');  

        if (!activeUser) {  
            alert('Please log in first!');  
            window.location.href = 'login.html';  
        }  



        const accountFeatures = [
        

        ];

        function formatNumber(num) {  
            if (num >= 1e12) return (num / 1e12).toFixed(1) + 'T';  
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';  
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';  
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';  
            return num;  
        }  

    async function getUserData() {
    const welcomeMsg = document.getElementById('welcomeMessage');
    const pointsElem = document.getElementById('points');
    const fallTokensElem = document.getElementById('fallTokens');
    
    if (!welcomeMsg || !pointsElem || !fallTokensElem) {
        console.error("Elements not found!");
        return;
    }
    
    const userDocRef = doc(db, 'users', activeUser);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
        const user = userDoc.data();
        welcomeMsg.innerText = `Welcome ${activeUser}!`;
        pointsElem.innerText = formatNumber(user.points);
        
        // تحديث عرض Fall Tokens
        fallTokensElem.innerText = user.fallTokens ? formatNumber(user.fallTokens) : '0';
        
        
            
                // تحديث حالة العناصر المشتراة
                const purchasedItems = user.purchasedItems || [];  
                document.querySelectorAll('.shop-item').forEach(item => {  
                    const itemName = item.querySelector('.item-name').innerText;  
                    const buyButton = item.querySelector('.buyButton');  
                    const sellButton = item.querySelector('.sellButton');

                    if (purchasedItems.includes(itemName)) {  
                        buyButton.innerText = "Purchased ";  
                        let img = document.createElement("img");  
                        img.src = "../icons/check.png";  
                        img.width = 10;  
                        img.height = 10;  
                        img.loading = "lazy";
                        buyButton.appendChild(img);  
                        buyButton.disabled = true;  
                        
                        if (sellButton) {
                            sellButton.style.display = 'inline-block';
                            const fullPrice = item.querySelector('.itemPrice').dataset.fullPrice;
                            const sellPrice = Math.floor(fullPrice / 2);
                            sellButton.dataset.sellPrice = sellPrice;
                            sellButton.dataset.itemName = itemName;
                            sellButton.innerHTML = `Sell ${formatNumber(sellPrice)}<img src="../icons/coinss_gif.gif" height="12">`;
                        }
                    } else if (sellButton) {
                        sellButton.style.display = 'none';
                    }
                });  
                
                // تحديث حالة الميزات المشتراة
                const unlockedFeatures = user.unlockedFeatures || [];
                document.querySelectorAll('.feature-item').forEach(featureItem => {
                    const featureId = featureItem.dataset.featureId;
                    const featureButton = featureItem.querySelector('.feature-button');
                    
                    if (unlockedFeatures.includes(featureId)) {
                        featureItem.classList.add('unlocked');
                        featureButton.classList.add('unlocked');
                        featureButton.innerHTML = "Purchased <img src='../icons/check.png' width='10' height='10'loading=>";
                    }
                });
            } else {  
                alert('User does not exist in the database!');  
                window.location.href = 'login.html';  
            }  
        }  

        document.addEventListener('DOMContentLoaded', () => {  
            createShopItems();  
            createFeatureItems();
            getUserData();  
        });  
function createShopItems() {
    const shopContainer = document.querySelector('.shop');
    shopItems.sort((a, b) => b.price - a.price);
    
    // Get items the user has already viewed from localStorage
    const viewedItems = JSON.parse(localStorage.getItem('viewedShopItems')) || [];
    
    shopItems.forEach(item => {
        const shopItem = document.createElement('div');
        shopItem.classList.add('shop-item');
        
        // Create tooltip for description
        const tooltip = document.createElement('div');
        tooltip.classList.add('tooltip');
        
        const tooltipImg = document.createElement('img');
        tooltipImg.src = item.imageUrl;
        tooltipImg.alt = item.name;
        tooltip.appendChild(tooltipImg);
        
        const tooltipText = document.createElement('span');
        tooltipText.textContent = item.description || "No description available";
        tooltip.appendChild(tooltipText);
        
        shopItem.appendChild(tooltip);
        
        // Add "New" badge if item hasn't been viewed
        const isNewItem = !viewedItems.includes(item.name);
        if (isNewItem) {
            const newBadge = document.createElement('span');
            newBadge.classList.add('new-badge');
            newBadge.textContent = ' ';
            shopItem.appendChild(newBadge);
            
            // When item is clicked, add to viewed items
            shopItem.addEventListener('click', function() {
                if (!viewedItems.includes(item.name)) {
                    viewedItems.push(item.name);
                    localStorage.setItem('viewedShopItems', JSON.stringify(viewedItems));
                    newBadge.style.display = 'none';
                }
            });
        }
        
        const imgShop = document.createElement('div');
        imgShop.classList.add('img-shop');
        const img = document.createElement('img');
        img.src = item.imageUrl;
        img.alt = item.name;
        img.height = 50;
        img.loading = "lazy";
        imgShop.appendChild(img);
        
        const itemName = document.createElement('p');
        itemName.classList.add('item-name');
        itemName.innerText = item.name;
        
        const priceLabel = document.createElement('p');
        priceLabel.classList.add('price-label');
        priceLabel.innerHTML = `Price: <span class="itemPrice" data-full-price="${item.price}">${formatNumber(item.price)}</span><img src="../icons/coinss_gif.gif" alt="Coin" height="12">`;
        
        const buyButton = document.createElement('button');
        buyButton.classList.add('buyButton');
        buyButton.innerText = "Buy";
        
        const sellButton = document.createElement('button');
        sellButton.classList.add('sellButton');
        sellButton.style.display = 'none';
        sellButton.innerHTML = `Sell ${formatNumber(Math.floor(item.price / 2))}<img src="../icons/coinss_gif.gif" height="12">`;
        sellButton.dataset.sellPrice = Math.floor(item.price / 2);
        sellButton.dataset.itemName = item.name;
        
        buyButton.addEventListener('click', async function() {
            const itemPrice = item.price;
            const userDocRef = doc(db, 'users', activeUser);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                let user = userDoc.data();
                let purchasedItems = user.purchasedItems || [];
                
                if (purchasedItems.includes(item.name)) {
                    alert("You already purchased this item!");
                    return;
                }
                
                if (user.points >= itemPrice) {
                    user.points -= itemPrice;
                    purchasedItems.push(item.name);
                    await updateDoc(userDocRef, {
                        points: user.points,
                        purchasedItems: purchasedItems
                    });
                    
                    // Play purchase sound
                    const purchaseSound = new Audio("../sounds/purchase_confirmation.ogg");
                    purchaseSound.play();
                    
                    document.getElementById('points').innerText = formatNumber(user.points);
                    this.innerText = "Purchased ";
                    let img = document.createElement("img");
                    img.src = "../icons/check.png";
                    img.width = 10;
                    img.height = 10;
                    this.appendChild(img);
                    this.disabled = true;
                    
                    sellButton.style.display = 'inline-block';
                    
                    alert(`Purchase Successful!\nYou bought ${item.name} for ${formatNumber(item.price)} coins!`);
                } else {
                    alert(`Not Enough Coins!\nYou need ${formatNumber(item.price - user.points)} more coins to buy this item.`);
                }
            }
        });
        
        sellButton.addEventListener('click', async function() {
            const sellPrice = parseInt(this.dataset.sellPrice);
            const itemName = this.dataset.itemName;
            
            const userDocRef = doc(db, 'users', activeUser);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                let user = userDoc.data();
                let purchasedItems = user.purchasedItems || [];
                
                const itemIndex = purchasedItems.indexOf(itemName);
                if (itemIndex > -1) {
                    purchasedItems.splice(itemIndex, 1);
                    user.points += sellPrice;
                    
                    await updateDoc(userDocRef, {
                        points: user.points,
                        purchasedItems: purchasedItems
                    });
                    
                    document.getElementById('points').innerText = formatNumber(user.points);
                    buyButton.disabled = false;
                    buyButton.innerText = "Buy";
                    buyButton.innerHTML = "Buy";
                    this.style.display = 'none';
                    
                    alert(`Item Sold!\nYou sold ${itemName} for ${formatNumber(sellPrice)} coins!`);
                }
            }
        });
        
        shopItem.appendChild(imgShop);
        shopItem.appendChild(itemName);
        shopItem.appendChild(priceLabel);
        shopItem.appendChild(buyButton);
        shopItem.appendChild(sellButton);
        shopContainer.appendChild(shopItem);
    });
}
  function createFeatureItems() {
    const featuresContainer = document.querySelector('.features-list');
    
    accountFeatures.forEach(feature => {
        const featureItem = document.createElement('div');
        featureItem.classList.add('feature-item');
        featureItem.dataset.featureId = feature.id;
        
        const featureBadge = document.createElement('div');
        featureBadge.classList.add('feature-badge');
        featureBadge.textContent = "OWNED";
        featureItem.appendChild(featureBadge);
        
        // إنشاء tooltip للوصف
        const tooltip = document.createElement('div');
        tooltip.classList.add('tooltip');
        
        const tooltipImg = document.createElement('img');
        tooltipImg.src = feature.imageUrl;
        tooltipImg.alt = feature.name;
        tooltip.appendChild(tooltipImg);
        
        const tooltipText = document.createElement('span');
        tooltipText.textContent = feature.description || "No description available";
        tooltip.appendChild(tooltipText);
        
        featureItem.appendChild(tooltip);
        
        const imgFeature = document.createElement('div');
        imgFeature.classList.add('feature-img');
        const img = document.createElement('img');
        img.src = feature.imageUrl;
        img.alt = feature.name;
        img.height = 50;
        imgFeature.appendChild(img);
        featureItem.appendChild(imgFeature);
        
        const featureName = document.createElement('p');
        featureName.classList.add('feature-name');
        featureName.innerText = feature.name;
        featureItem.appendChild(featureName);
        
        const priceLabel = document.createElement('p');
        priceLabel.classList.add('price-label');
        priceLabel.innerHTML = `Price: <span class="feature-price" data-full-price="${feature.itemPrice}">${formatNumber(feature.itemPrice)}</span><img src="../icons/coinss_gif.gif" alt="Coin" height="12">`;
        featureItem.appendChild(priceLabel);
        
        const featureButton = document.createElement('button');
        featureButton.classList.add('feature-button');
        featureButton.innerText = "Buy";
        featureButton.dataset.featureId = feature.id;
        featureButton.dataset.price = feature.itemPrice;
        
        featureButton.addEventListener('click', async function() {
            const featureId = this.dataset.featureId;
            const featurePrice = parseInt(this.dataset.price);
            
            const userDocRef = doc(db, 'users', activeUser);
            const userDoc = await getDoc(userDocRef);
            
if (userDoc.exists()) {
    const user = userDoc.data();
    const unlockedFeatures = user.unlockedFeatures || [];
    const purchasedItems = user.purchasedItems || []; // ✅ تعريف المصفوفة هنا
    
    if (unlockedFeatures.includes(featureId)) {
        alert("You already have this feature unlocked!");
        return;
    }
    
    if (user.points >= featurePrice) {
        user.points -= featurePrice;
        purchasedItems.push(feature.name);
        
        await updateDoc(userDocRef, {
            points: user.points,
            purchasedItems: purchasedItems
        });
        
        
                    // تشغيل الصوت عند الشراء
                    const purchaseSound = new Audio("../sounds/purchase_confirmation.ogg");
                    purchaseSound.play();
                    
                    document.getElementById('points').innerText = formatNumber(user.points);
                    this.innerText = "Purchased ";
                    
                    let img = document.createElement("img");
                    img.src = "../icons/check.png";
                    img.width = 10;
                    img.height = 10;
                    this.appendChild(img);
                    this.disabled = true;
                    
                    // تحقق من وجود sellButton قبل استخدامه
                    const sellButton = document.querySelector('.sell-button');
                    if (sellButton) {
                        sellButton.style.display = 'inline-block';
                    }
                    
                    alert(`Purchase Successful!\nYou bought ${feature.name} for ${formatNumber(feature.itemPrice)} coins!`);
                } else {
                    alert(`Not Enough Coins!\nYou need ${formatNumber(featurePrice - user.points)} more coins to unlock this feature.`);
                }
            }
        });
        
        featureItem.appendChild(featureButton);
        featuresContainer.appendChild(featureItem);
    });
}

        // بقية الدوال كما هي ...
        window.openLootBox = function (boxType) {  
            const userDocRef = doc(db, 'users', activeUser);  
            getDoc(userDocRef).then(async (userDoc) => {  
                if (userDoc.exists()) {  
                    const user = userDoc.data();  
                    let boxPrice;  
                    let minPoints, maxPoints;  
                    let randomPoints;  

                    switch (boxType) {  
                        case 'cheap':  
                            boxPrice = 199;  
                            minPoints = 99;  
                            maxPoints = 800;  
                            break;  
                        case 'medium':  
                            boxPrice = 2000;  
                            minPoints = 250;  
                            maxPoints = 4200;  
                            break;  
                        case 'expensive':  
                            boxPrice = 10100;  
                            minPoints = 100;  
                            maxPoints = 99999;  
                            break;  
                        default:  
                            alert("Invalid box type!");  
                            return;  
                    }  

                    if (user.points >= boxPrice) {  
                        user.points -= boxPrice;  

                        let randomChance;  
                        if (boxType === 'cheap') {  
                            randomChance = Math.random();  
                            if (randomChance <= 0.25) {  
                                randomPoints = Math.floor(Math.random() * (800 - 500 + 1) + 900);  
                            } else if (randomChance <= 0.55) {  
                                randomPoints = Math.floor(Math.random() * 98) + 1;
                            } else {  
                                randomPoints = Math.floor(Math.random() * (500 - 99 + 1) + 99);  
                            }  

                        } else if (boxType === 'medium') {  
                            randomChance = Math.random();  
                            if (randomChance <= 0.20) {  
                                randomPoints = Math.floor(Math.random() * 249) + 1;
                            } else if (randomChance <= 0.80) {  
                                randomPoints = Math.floor(Math.random() * (2500 - 250 + 1) + 250);  
                            } else {  
                                randomPoints = Math.floor(Math.random() * (5000 - 2500 + 1) + 2500);  
                            }  

                        } else if (boxType === 'expensive') {  
                            randomChance = Math.random();  
                            if (randomChance <= 0.10) {  
                                randomPoints = Math.floor(Math.random() * (90000 - 9000 + 1) + 13000);  
                            } else if (randomChance <= 0.40) {  
                                randomPoints = Math.floor(Math.random() * 7000) + 100;
                            } else {  
                                randomPoints = Math.floor(Math.random() * (13000 - 5000 + 1) + 7000);  
                            }  
                        }   
                        
                        user.points += randomPoints;  
                          
                        await updateDoc(userDocRef, { points: user.points });  

                        document.getElementById('points').innerText = formatNumber(user.points);  
                        alert(`You opened a ${boxType} box!\nYou earned ${formatNumber(randomPoints)} coins!`);
                    } else {  
                        alert(`Not Enough Coins!\nYou need ${formatNumber(boxPrice - user.points)} more coins to buy this box.`);
                    }  
                } else {  
                    alert('User does not exist!');  
                }  
            }).catch((error) => {  
                console.error("Error getting document: ", error);  
            });  
        };  
        
        // متغيرات التحويل
const CONVERSION_RATE = 100000; // 100,000 points = 1 Fall Token

// عناصر DOM
const pointsInput = document.getElementById('pointsToConvert');
const tokensResult = document.getElementById('tokensResult');
const convertBtn = document.getElementById('convertBtn');

// تحديث النتيجة عند تغيير القيمة
pointsInput.addEventListener('input', updateConversionResult);

// زر التحويل
convertBtn.addEventListener('click', convertPointsToTokens);

function updateConversionResult() {
    const points = parseFloat(pointsInput.value) || 0;
    const tokens = points / CONVERSION_RATE;
tokensResult.textContent = parseFloat(tokens.toFixed(5)).toString();
}

async function convertPointsToTokens() {
    const pointsToConvert = parseInt(pointsInput.value);
    
    if (!pointsToConvert || pointsToConvert < 1) {
        alert("يجب إدخال عدد صحيح من النقاط (1 كحد أدنى)");
        return;
    }
    
    const userDocRef = doc(db, 'users', activeUser);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists()) {
        const user = userDoc.data();
        
        if (user.points < pointsToConvert) {
            alert(`نقاطك غير كافية! تحتاج إلى ${pointsToConvert - user.points} نقطة إضافية`);
            return;
        }
        
        // حساب Tokens مع تقريب صحيح
        const tokensToAdd = parseFloat((pointsToConvert / CONVERSION_RATE).toFixed(5));
        const currentTokens = parseFloat(user.fallTokens || 0);
        const newTokens = parseFloat((currentTokens + tokensToAdd).toFixed(5));
        
        // تحديث قاعدة البيانات
        await updateDoc(userDocRef, {
            points: user.points - pointsToConvert,
            fallTokens: newTokens
        });
        
        // تحديث الواجهة فوراً
        document.getElementById('points').innerText = formatNumber(user.points - pointsToConvert);
        document.getElementById('fallTokens').innerText = formatNumber(newTokens);
        pointsInput.value = '';
        tokensResult.textContent = '0';
        
        alert(`تم التحويل بنجاح!\n${formatNumber(pointsToConvert)} نقطة → ${tokensToAdd} Fall Tokens`);
    }
}
    </script>  
    <script>
window.addEventListener('scroll', function() {
  const header = document.querySelector('.sticky-header');
  if (window.scrollY > 0) {
    header.classList.add('sticky');
  } else {
    header.classList.remove('sticky');
  }
});
</script>
    <script>  
        function goBack() {  
            if (window.history.length > 1) {  
                window.history.back();  
            } else {  
                window.location.href = '/';
            }  
        }  
    </script>
</body>  
</html>