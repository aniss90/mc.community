<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../style/main.css">
  <link rel="icon" type="png" href="=../icons/Win_Computer.gif">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>General page</title>
  <style>
    @font-face {
      font-family: minecraft;
      src: url('../font/Minecraft-Default.otf');
    }
    @font-face {
      font-family: minecraft-ten;
      src: url('../font/Minecraft-Ten.ttf');
    }
    @font-face {
      font-family: minecraft-five;
      src: url('../font/Minecraft-Five.ttf');
    } 

    
    
    /* التنبيهات المخصصة */
    #points {
      color: #FFBC13; 
      font-size: 15px; 
    }

    #welcomeMessage {
      color: #FFFFFF; 
      font-size: 15px; 
      font-family: minecraft-five; 
    }

    
    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    
    
    /* تنبيه مخصص */
    .custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(5px);
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .custom-alert-box {
      background-color: white;
      padding: 30px;
      text-align: center;
      border-radius: 20px;
      font-family: minecraft;
      font-size: 20px;
      color: black;
      animation: popUp 0.5s ease;
      min-width: 250px;
    }

    .custom-alert-box h2 {
      margin: 0;
      font-size: 22px;
    }

    .custom-alert-points {
      font-size: 35px;
      font-weight: bold;
      margin: 10px 0;
    }

    /* أنيميشن */
    @keyframes popUp {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* قائمة أسماء المستخدمين */
.username-dropdown {
  position: absolute;
  transform: translate( 35%, 17%); /* تعديل المركز بدقة */
  background-color: #333; /* خلفية داكنة */
  max-height: 60%;
  overflow-y: auto;
  z-index: 1000;
  max-width: 58%;
  width: 60%;
  display: none;
  border-top: 2px solid #737373;
        border-left: 2px solid #737373;
        border-right: 2px solid #737373;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  bottom: 100%;
}

.username-dropdown div {
  padding: 8px 12px;
  cursor: pointer;
  color: white; /* لون الخط أبيض */
  border-bottom: 1px solid #444; /* خط فاصل بلون داكن */
}

.username-dropdown div:last-child {
  border-bottom: none;
}

.username-dropdown div:hover {
  background-color: #555; /* لون خلفية عند التحويم */
  color: white; 
  background-color: #3d3d3d;
  transition: background-color 0.2s ease; /* تأثير سلس */

}

    .username-dropdown div {
  padding: 8px 12px;
  cursor: pointer;
  
}
  .menu {
            position: absolute;
            border: none;
            top: 20px;
            left: 10px;
            cursor: pointer;
            
            padding: 10px;
            background: url(../icons/menu@0.5x.icon-e2970.png);
            background-size:  contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 9999;
        } 
          .users-btn {
            position: absolute;
            border: none;
            right: 10px;
            top: 20px;
            cursor: pointer;
            padding: 10px;
            background: url(../icons/friends-9e435.png);
            background-size:  contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 9999;
          
        } 
       
        .rate {
            position: fixed;
            display: flex;
            border: none;
            right: 45px;
            top: 20px;
            cursor: pointer;
            padding: 10px;
            background: url(../icons/star.png);
            background-size:  contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 9999;
            gap: 5px;
        }  

.username-dropdown div:last-child {
  border-bottom: none; /* إزالة الخط من آخر عنصر */
}

.username-dropdown div:hover {
  background-color: #515151;
} 
/* أنماط جديدة للقائمة المنسدلة تحت الزر */
.logout-dropdown {
  position: absolute;
  top: 10px;
  left: 10px;
  background-color: #9C9C9C00; /* يمكنك تقليل العتامة هنا إذا أردت */
  backdrop-filter: blur(8px); /* هذه الخاصية تضيف تأثير البلور */
  -webkit-backdrop-filter: blur(5px);
  border-radius: 5px;
  z-index: 10000;
  display: none;
  text-align: left;
  border: 1px solid #555;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  min-width: 180px;
  animation: slideDown 0.2s ease-out;
}

.logout-dropdown h3 {
  color:#000000 ;
  margin: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid #555;
  font-family: minecraft;
  font-size: 14px;
}

.logout-options {
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 8px;
}



/* تعديل أنيميشن لتناسب القائمة المنسدلة */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
/* أنماط أزرار القائمة المنسدلة */
.dropdown-button {
  background: none;
  border: none;
  color: #FFFFFF;
  text-shadow: 0px 2px 0px #000000;
  padding: 8px 12px;
  text-align: auto;
  cursor: pointer;
  font-family: minecraft-five;
  font-size: 13px;
  border-radius: 3px;
  width: 100%;
  transition: all 0.3s ease;
}

.dropdown-button:hover {
  background-color: #444;
  color: white;
}

#confirmLogout {
  color: #ff6b6b;
  transition: all 0.3s ease;
}

#confirmLogout:hover {
  background-color: #ff3b3b;
  color: white;
}
#points{
            text-shadow:0px 1px 0px #3A2700;
            background: #916204;
            border: 2px solid #A6730F;
            color: #FFD952;
            font-size: 17px;
}

/* إضافة أنميشن للعداد */
@keyframes countUp {
  from {
    transform: scale(1.2);
    opacity: 0.7;
  }
  to {
    transform: scale(1);
    opacity: 1;
    
  }
}

.counting {
  animation: countUp 0.3s ease-out;
}
/* تأثيرات جديدة للعداد */
@keyframes countDown {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
    color: #FFD952;
  }
  50% {
    transform: translateY(-10px) scale(1.1);
    opacity: 0.8;
    color: #ff6b6b;
  }
  100% {
    transform: translateY(0) scale(1);
    opacity: 1;
    color: #FFD952;
  }
}

.counting-down {
  animation: countDown 0.5s ease-out;
}
#points-float{
  padding-bottom: 20px;
  z-index: 10000;
}
/* إضافة أنماط للإشعارات */
.notification-container {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 10000;
    max-width: 300px;
}

.notification {
    background-color: #2C8014;
    color: white;
    padding: 15px;
    margin-bottom: 10px;
    z-index: 10000;
    border: 2px solid #4f913c;
    box-shadow: 0 3px 0px rgba(1, 97, 12, 1);
    cursor: pointer;
    transform: translateX(100%);
    animation: slideIn 0.5s forwards;
    display: flex;
    align-items: center;
}

.notification img {
    width: 30px;
    height: 30px;
    margin-left: 10px;
    
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: bold;
    margin-bottom: 5px;
    font-family: minecraft-five;
    font-size: 14px;
}

.notification-message {
    font-family: minecraft-five;
    font-size: 12px;
    opacity: 0.9;
}

@keyframes slideIn {
    to { transform: translateX(0); }
}

@keyframes slideOut {
    to { transform: translateX(100%); }
}
.img2 img{
  height: 12px;
  width: auto;
}
span{
  font-family: minecraft-five;
}

 .coin-particle {
      position: absolute;
      width: 16px;
      height: 16px;
      background-image: url('../icons/coinss_gif.gif');
      background-size: cover;
      pointer-events: none;
      z-index: 1;
      animation: float 1.5s ease-out forwards;
      opacity: 1;
    
    }

    @keyframes float {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(var(--move-x), var(--move-y)) scale(1.2);
        opacity: 0;
      }
    }

#whiteButton{
  text-shadow: 1px 1px 0.9px rgba(180, 125, 0, 1);
            height: 40px;
            width: 100%;
            border: 2px solid #FFFFFF;
            border: 2px solid #8C6A15;
            background-color: #2E2100;
                box-shadow:
        0px 3px 0px #2E2100,
        0 0 0 var(--border-thickness) #1a1a1b,
        0 3px 0 2px #1a1a1b;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            display: inline-block;
            padding: 10px;
            color: #FFFFFF;
            margin: auto;
            transition: all 0.3s ease;
}
#whiteButton:hover{
            color:#FFFFFF ;
            width: 100%;
            position: relative;
            border: 2px solid #FFD15E;
            background-color: #2E2100;
            box-shadow:
        0px 0px 15px #BF9837,
        0 0 0 var(--border-thickness) #1a1a1b,
        0 0 0 0 #1a1a1b;
  
}
/* تأثيرات الظهور التدريجي للصفحة */


@keyframes fadeIn {
  to {
    opacity: 1;
  }
}
.content {
  opacity: 0;
  transform: translateY(10px);
  animation: slideDownFadeIn 0.7s ease-out 0.4s forwards;
}
 

.content {
  opacity: 0;
  transform: translateY(10px);
  animation: slideUpFadeIn 0.7s ease-out 0.4s forwards;
}

.title {
  opacity: 0;
  transform: translateY(10px);
  animation: slideUpFadeIn 0.9s ease-out 0.9s forwards;
}

.description {
  opacity: 0;
  transform: translateY(10px);
  animation: slideUpFadeIn 0.9s ease-out 0.8s forwards;
}

.button {
  opacity: 0;
  transform: translateY(10px);
  animation: slideUpFadeIn 0.9s ease-out 1s forwards;
}

@keyframes slideDownFadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUpFadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
#welcomeMessage {
  
  transform: translateY(10px);
  transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  white-space: nowrap;
  overflow: hidden;
  font-size: 1.2em;
}

.smooth-typing {
  border-right: 2px solid rgba(0, 0, 0, 0.7);
  animation: 
    blinkCursor 0.8s infinite,
    gentlePulse 0.5s ease-in-out infinite alternate;
}

.typing-complete {
  border-right: none;
  animation: gentleFadeIn 0.5s ease-out;
}

@keyframes blinkCursor {
  0%, 100% { border-color: rgba(0, 0, 0, 0.2); }
  50% { border-color: rgba(0, 0, 0, 0.7); }
}

@keyframes gentlePulse {
  from { opacity: 0.95; }
  to { opacity: 1; }
}

@keyframes gentleFadeIn {
  from { transform: translateY(-2px); }
  to { transform: translateY(0); }
}
/* أنماط نافذة التقييم */
/* أنماط نافذة التقييم المعدلة لتكون مثل قائمة menu */
/* أنماط نافذة التقييم - مطابقة لشكل قائمة menu */
.rating-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none;
  justify-content: center;
  align-items: flex-start;
  z-index: 10000;
  padding-top: 60px;
}

.rating-box {
background-color: #9C9C9C00; /* يمكنك تقليل العتامة هنا إذا أردت */
  backdrop-filter: blur(8px); /* هذه الخاصية تضيف تأثير البلور */
  -webkit-backdrop-filter: blur(5px); 
  border-radius: 5px;
  padding: 15px;
  text-align: center;
  border: 1px solid #555;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  min-width: 250px;
  max-width: 300px;
  animation: slideDown 0.2s ease-out;
  position: absolute;
  right: 10px;
  top: 50px;
}

.rating-title {
  color: #000000;
  margin: 0 0 10px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #555;
  font-family: minecraft;
  font-size: 14px;
  text-align: left;
}

.stars-container {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 15px 0;
}

.star {
  font-size: 24px;
  color: #555;
  cursor: pointer;
  transition: all 0.2s;
  text-shadow: 0px 2px 9px #000000;
}

.star.active {
  color: #FFD700;
  text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
}

#confirmRating {
  background: none;
  border: none;
  color: #36E23A;
  text-shadow: 0px 2px 0px #000000;
  padding: 8px 12px;
  cursor: pointer;
  font-family: minecraft-five;
  font-size: 13px;
  border-radius: 3px;
  width: 100%;
  transition: background 0.2s;
  text-align: center;
}

#confirmRating:hover {
  background-color: #31AF34;
  color: white;
}

.rated-message {
  color: #FFFFFF;
  font-family: minecraft-five;
  font-size: 13px;
  margin-top: 10px;
  display: none;
  text-align: left;
}

.sticky-header.sticky {
  position: fixed;
  top: 0;
  animation: fadeIn 0.3s ease-in-out;
  transition: all 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0.9; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
} 
.header {
  background-color: #222222;
  padding: 10px 0;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  
  /* احتفظ بباقي خصائص التصميم الحالية */
}
     .sticky-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  width: 100%;
  
}
/* تأثير النقاط المضافة */
.points-added {
  position: absolute;
  top: -20px; /* ارفعه قليلاً فوق النص */
  left: 59px;
  transform: translateX(50%);
  color: #2EFF37 !important;
  font-weight: bold;
  font-size: 1.2em !important;
  transition: all 1s ease-out;
  pointer-events: none;
  animation: floatUp 1s ease-out forwards;
  text-shadow: 0px 1px 0px #000000;
  
}

@keyframes floatUp {
  0% {
    transform: translateY(0);
    opacity: 1;
  }
  100% {
    transform: translateY(-30px);
    opacity: 0;
  }
}

#fallTokens{
text-shadow:0px 1px 0px #3A1B00;
background: #915E04;
border: 2px solid #A65E0F;
color: #FFA252;
font-size: 17px;
transition: all 0.5s;
}
.marketplace-container {
  position: relative;
  
}


.particle {
  position: absolute;
  width: 7px;
  height: 7px;
  background-color: #FFC208;
  
  animation: riseUp 3s ease-out forwards;
  pointer-events: none;
  box-shadow: 2px 1px 15px 2px rgba(255, 210, 73, 1);
-webkit-box-shadow: 2px 1px 15px 2px rgba(255, 210, 73, 1);
-moz-box-shadow: 2px 1px 15px 2px rgba(255, 210, 72, 1);
  z-index: 1;
  
}

@keyframes riseUp {
  0% {
    transform: translateY(0) scale(1.4);
    opacity: 1;
  }
  40%{
    
    opacity: 1;
  }
  100% {
    transform: translateY(-60px) scale(0.7);
    opacity: 0;
  }
}
#marketplacebtn {
  width: 100%;
  padding: 10px;
  background-color: #FFFEBD;
  border: 2px solid #FFC208;
      box-shadow:
        0px var(--border-2x-thickness) 0px #97966E,
        0 0 0 var(--border-thickness) #1a1a1b,
        0 var(--border-2x-thickness) 0 var(--border-thickness) #1a1a1b;
  border-radius: 8px;
  transition: all 0.5s;
  position: relative;
  transition: all 0.3s ease;
  
}
#marketplacebtn:hover{
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  background-color: #9A996D;
border: 2px solid #FFE492;
    box-shadow:
        0px 0px 14px #77781E,
        0 0 0 var(--border-thickness) #1a1a1b,
        0 0 0 0 #1a1a1b;
  transform: translateY(var(--border-2x-thickness));
transition: all 0.3s ease;
}
#achievementbtn{
  width: 100%;
padding: 10px;
background-color: #966001;
border: 2px solid #F1BD0B;
box-shadow: 0 4px 0 #6D511F;
transition: all 0.5s;
color: #FFFFFF;
text-shadow: 2px 2px 5px #4F3506;
transition: all 0.3s ease;
}
#achievementbtn:hover{
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  background-color: #452D05;
border: 2px solid #FFDF92;
color: #F5F5F5;
box-shadow: 2px 0 15px #FFDF92;
transition: all 0.3s ease;
}
.currency-selector {
  position: relative;
  display: inline-block;
}

.currency-toggle {
  background: #8C6A15;
  border: none;
  border-radius: 5px;
  padding: 5px 10px;
  cursor: pointer;
  align-items: center;
  gap: 5px;
  height: 40px;
  transition: all 0.3s ease;
}

.currency-toggle:hover {
  background: #A57C1B;
}

.currency-dropdown {
  display: none;
  position: absolute;
  background-color: #2E2100;
  border: 1px solid #8C6A15;
  border-radius: 5px;
  min-width: 120px;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  z-index: 1;
  padding: 5px 0;
  
}

.currency-dropdown.show {
  display: block;
}

.currency-option {
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.currency-option:hover {
  background-color: #8C6A15;
}
.send-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 15px;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.input-group label {
  font-size: 14px;
  color: #d4d4d4;
}

.input-row {
  display: flex;
  gap: 15px;
}

.input-row .input-group {
  flex: 1;
}

.currency-group {
  max-width: 120px;
}

.send-container input {
  padding: 8px 12px;
  border-radius: 5px;
  
  color: white;
}

.send-button {
  background: #8C6A15;
  color: white;
  border: 2px solid ;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 10px;
  transition: all 0.3s ease;
}

.send-button:hover {
  background: #A57C1B;
}

.result-message {
  margin-top: 15px;
  padding: 10px;
  border-radius: 5px;
  text-align: center;
} 
.username-dropdown {
  display: none;
  position: absolute;
  background-color: #454545BF;
  backdrop-filter: blur(8px); 
  border: 1px solid #8B8B8B;
  border-radius: 5px;
  width: calc(100% - 24px); /* نفس عرض حقل الإدخال */
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  margin-top: 35px; /* تحت حقل الإدخال مباشرة */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.username-dropdown.show {
  display: block;
}

.username-item {
  padding: 10px 15px;
  cursor: pointer;
  color: #e0e0e0;
  border-bottom: 1px solid #3a3a3a;
  transition: all 0.2s;
}

.username-item:last-child {
  border-bottom: none;
}

.username-item:hover {
  background-color: #8C6A15;
  color: white;
}

.username-item.highlighted {
  background-color: #A57C1B;
  color: white;
} 
    
    .Elements-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
    }
    
    .Elements-left {
      flex: 1;
    }
    
    .Elements-right {
flex: 1;
    }
    
  
      @media (max-width: 768px) {
      .Elements-container {
        flex-direction: column;
  
      }
      
      .Elements-right {
        order: 2;
      width: 100%;
      }
      
      .Elements-left {
        order: 1;
        width: 100%;
      }
      
      .custom-alert-content {
        width: 90%;
      }
    }
  </style>
  <title>general </title>
</head>
  <script type="module" src="../scripts/main.js"></script>
<body>
<!-- حاوية الإشعارات -->
<div class="notification-container" id="notificationContainer"></div>
<div class="sticky-header"> 
  <div class="header">
    <button class="users-btn" id="users-btn" type="button"></button>
    <button class="menu" id="menuButton" type="button"></button>
    <button class="rate" id="rateButton" type="button"></button>
  general
  <img src="../icons/Win_Computer.gif" loading="lazy" height="25">  
  </div> 
  <div class="logout-dropdown" id="logoutDropdown">
  <h3>MENU</h3>
  <div class="logout-options">
    <button id="settingsButton" class="dropdown-button">Settings</button>
    
    <button id="cancelLogout" class="dropdown-button">Close</button>
    <button id="confirmLogout" class="dropdown-button">Sign out </button>
  </div>
  
</div>
  <div id="customAlert" class="custom-alert-overlay">
    <div class="custom-alert-box" id="customAlertBox">
      <h2>  🎉Congratulations ,you get </h2>
      <div class="custom-alert-points" id="customAlertPoints">0</div>
    </div>
  </div>
  <!-- نافذة التقييم -->
<!-- نافذة التقييم -->
<div class="rating-overlay" id="ratingOverlay">
  <div class="rating-box">
    <h3 class="rating-title">Rate Our Website</h3>
    <div class="stars-container">
      <div class="star" data-rating="1">★</div>
      <div class="star" data-rating="2">★</div>
      <div class="star" data-rating="3">★</div>
      <div class="star" data-rating="4">★</div>
      <div class="star" data-rating="5">★</div>
    </div>
    <button id="confirmRating">Confirm Rating</button>
    <div class="rated-message" id="ratedMessage">Thank you ❤️!</div>
  </div>
</div>
</div>
  <div class="content"> 
    <div class="Elements-container">
            <div class="Elements-left">    
    <h1 id="welcomeMessage"><img class="lodinimg" src="../icons/loading_spinner.gif" height="15" /></h1>

<div class="points">
  <div class="title">
    your wallet : <span id="points">
      <img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span>
    <span id="points-float" style="display: inline-block; position: relative;"></span><img src="../icons/coinss_gif.gif" loading="lazy" height="15">|
    <span id="fallTokens">
      <img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span>
    <img src="../icons/fall_token.png" alt="Fall Token" height="15">
  </div>
</div>


      <div class="description"> 
        Get coins between 1000 coine and 1 coine.
        <button id="whiteButton"> <img src="../icons/Alot_of_coins.gif" loading="lazy"height="16"> coins +
        <audio id="coinSound" src="../sounds/coin_fill_up.ogg"></audio>
        </button>
        <!-- promo-banner يظهر فقط إذا كان العرض مفعّل -->
<div id="promo-banner" style="display: none; background: gold; padding: 10px;">
  🎉 عرض خاص بمناسبة العيد! احصل على 50 نقطة مجانًا!
</div>
      </div> 
        <div class="description"> 
          <div class="title">marketplace</div> Buy features and things for your account 
          using your coins
          <a href="marketplace.html">
            <div class="marketplace-container ">
              <button id="marketplacebtn"> <img src="../icons/Marketplace_new_logo.png"loading="lazy" height="15"> Marketplace</button>
            </div>
          </a> 
        </div>
        <!---
                <div class="description">
          <div class="title">Achievements</div> Complete missions to get achievements. 
          <a href="marketplace.html">
            <div class="button">
              <button id="achievementbtn">achievements <img src="../icons/Achievements_book.png" loading="lazy" height="15"></button>
            </div>
          </a>
        </div>

         <div class="description"> 
           <div class="title">Trading </div>Trade your coins on the MC Co trading platform.
             <a href="trading.html">
               <div class="button">
                <button id="blueButton">Dev.Trading dashboard <img src="../icons/chart_up.png"loading="lazy" height="15"></button>
                 </div>
               </a> 
        </div>
        -->
            </div>
            <div class="Elements-right"> 
<div class="description">
  <div class="title"> Send coins / Fall Tokens </div>
  Send coins or Fall Tokens to other users.
  
  <div class="send-container">
  <div class="input-group">
  <label for="receiverUsername">Recipient username:</label>
  <input type="text" id="receiverUsername" name="username" placeholder="Username " autocomplete="off">
  <div class="username-dropdown" id="usernameDropdown"></div>
</div>
    
    <div class="input-row">
      <div class="input-group">
        <label for="sendPointsAmount">Amount:</label>
        <input type="number" id="sendPointsAmount" name="points" placeholder="0.00" step="any" required>
      </div>
      
      <div class="input-group currency-group">
        <label>Currency:</label>
        <div class="currency-selector">
          <button id="currencyToggle" class="currency-toggle">
            <img src="../icons/coinss_gif.gif" id="currencyIcon" height="20">
          </button>
          <div class="currency-dropdown" id="currencyDropdown">
            <div class="currency-option" data-currency="points" data-icon="../icons/coinss_gif.gif">
              <img src="../icons/coinss_gif.gif" height="15"> Coins
            </div>
            <div class="currency-option" data-currency="fallTokens" data-icon="../icons/fall_token.png">
              <img src="../icons/fall_token.png" height="15"> Fall Tokens
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <button id="redButton" class="send-button">
      Send <img src="../icons/gift_gif.gif" loading="lazy" height="15">
    </button>
  </div>
  
  <div id="sendPointsResult" class="result-message"></div>
</div>
            </div>
    </div>
  <!-- يضاف داخل div.header بعد زر الرجوع -->
<script>
  const button = document.getElementById('marketplacebtn');
  const container = document.querySelector('.marketplace-container');
  
  function createParticle() {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    
    // توليد موقع عشوائي حول الزر
    const padding = 10;
    const randomX = Math.random() * (button.offsetWidth + padding * 2) - padding;
    const randomY = Math.random() * (button.offsetHeight + padding * 2) - padding;
    
    particle.style.left = `${randomX}px`;
    particle.style.top = `${randomY}px`;
    
    container.appendChild(particle);
    
    // حذف بعد انتهاء الأنميشن
    setTimeout(() => {
      particle.remove();
    }, 3000);
  }
  
  // توليد جزيئات بشكل مستمر
  setInterval(createParticle, 300);
</script>

<script>
  document.getElementById("users-btn").addEventListener("click", function() {
    window.location.href = "users_list.html";
  });
</script>
  <script>
    document.getElementById('whiteButton').addEventListener('click', function () {
      const coinCount = Math.floor(Math.random() * 8) + 5; // عدد العملات من 5 إلى 12
      for (let i = 0; i < coinCount; i++) {
        createCoinParticle();
      }
    });

    function createCoinParticle() {
      const button = document.getElementById('whiteButton');
      const buttonRect = button.getBoundingClientRect();
      const description = document.querySelector('.description');

      const coin = document.createElement('div');
      coin.className = 'coin-particle';

      // مكان العملة: عشوائي حول الزر
      const padding = 30; // المسافة حول الزر
      const randomX = Math.random() * (buttonRect.width + padding * 2) - padding;
      const randomY = Math.random() * (buttonRect.height + padding * 2) - padding;

      coin.style.left = (button.offsetLeft + randomX) + 'px';
      coin.style.top = (button.offsetTop + randomY) + 'px';

      // حركة صغيرة لكل عملة
      const moveX = (Math.random() - 0.5) * 60 + 'px';
      const moveY = (Math.random() - 0.5) * 60 + 'px';

      coin.style.setProperty('--move-x', moveX);
      coin.style.setProperty('--move-y', moveY);

      description.appendChild(coin);

      // حذف العملة بعد انتهاء الأنميشن
      setTimeout(() => {
        coin.remove();
      }, 1500);
    }

  document.getElementById("whiteButton").addEventListener("click", function () {
    const sound = new Audio("../sounds/coin_fill_up.ogg");
    sound.play();
  });
  </script>

<script type="module">
import { db } from '../scripts/main.js';   
import {  
  doc,  
  getDoc,  
  setDoc,  
  updateDoc,  
  collection,  
  getDocs,  
  onSnapshot,  
  query,  
  where,  
  orderBy,  
  addDoc, 
  increment // أضف هذه الدالة  
} from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";  
      
    import {  
      GoogleAuthProvider,  
      signInWithPopup,  
      signInAnonymously,  
      onAuthStateChanged,  
      signOut  
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";  
        
const activeUser = localStorage.getItem('activeUser');  
  

if (!activeUser) {  
  alert('Please log in first!');  
  window.location.href = 'login.html';  
}  


// دالة لجلب بيانات المستخدم
async function getUserData() {
  const userDocRef = doc(db, 'users', activeUser);
  const snap = await getDoc(userDocRef);
  
  let user;
  if (!snap.exists()) {
    // أنشئ الوثيقة لأول مرة
    await setDoc(userDocRef, DEFAULT_USER_SCHEMA);
    user = DEFAULT_USER_SCHEMA;
  } else {
    // صحّح أي نقص في الحقول
    user = await ensureUserSchema(userDocRef, snap.data());
  }
  
  const welcomeElement = document.getElementById('welcomeMessage');
  welcomeElement.style.opacity = '1';
  welcomeElement.style.transform = 'translateY(0)';
  await smoothTypeWriter(`Welcome ${activeUser}!`, welcomeElement, 80);
  
  // عرض النقاط
  formatPoints(user.points ?? 0, document.getElementById('points'));
  
  // عرض Fall Tokens
  formatPoints(user.fallTokens ?? 0, document.getElementById('fallTokens'));
  
}
  const DEFAULT_USER_SCHEMA = {
  notification: {
    from: null,
    amount: 0,
    currency: 'points',
    read: true
  },
  lastSeenMessages: {},
};
async function ensureUserSchema(userDocRef, rawData) {
  const data = rawData || {};
  const patch = {};
  
  // أكمل الحقول الناقصة
  for (const [key, defaultVal] of Object.entries(DEFAULT_USER_SCHEMA)) {
    if (data[key] === undefined) {
      patch[key] = defaultVal;
      continue;
    }
    
    // تصحيح أنواع الحقول الأساسية (اختياري لكن مفيد)
    if (typeof defaultVal === 'number' && typeof data[key] !== 'number') {
      const fixed = Number(data[key]);
      patch[key] = Number.isFinite(fixed) ? fixed : 0;
    }
    
    if (Array.isArray(defaultVal) && !Array.isArray(data[key])) {
      patch[key] = Array.isArray(data[key]) ? data[key] : [];
    }
    
    if (typeof defaultVal === 'object' && !Array.isArray(defaultVal)) {
      patch[key] = { ...defaultVal, ...data[key] }; // دمج آمن
    }
  }
  
  if (Object.keys(patch).length) {
    await setDoc(userDocRef, patch, { merge: true });
    return { ...DEFAULT_USER_SCHEMA, ...data, ...patch };
  }
  
  return data;
}
// عند تحميل الصفحة، تحقق من حالة التقييم  
document.addEventListener('DOMContentLoaded', function() {  
  checkRatingStatus();  
});  

  
// تحقق من حالة التقييم (من localStorage وقاعدة البيانات)  
async function checkRatingStatus() {  
  const rateButton = document.getElementById('rateButton');  
    
  // تحقق من localStorage أولاً لأداء أسرع  
  const localRated = localStorage.getItem('userRated');  
  if (localRated === 'true') {  
    rateButton.style.display = 'none';  
    return;  
  }  
    
  // إذا لم يكن هناك بيانات في localStorage، تحقق من قاعدة البيانات  
  try {  
    const userDocRef = doc(db, 'users', activeUser);  
    const userDoc = await getDoc(userDocRef);  
      
    if (userDoc.exists() && userDoc.data().hasRated) {  
      localStorage.setItem('userRated', 'true');  
      rateButton.style.display = 'none';  
    }  
  } catch (error) {  
    console.error('Error checking rating status:', error);  
  }  
}  

// عند النقر على زر التقييم
document.getElementById('rateButton')?.addEventListener('click', function(e) {
  e.stopPropagation();
  const ratingOverlay = document.getElementById('ratingOverlay');
  ratingOverlay.style.display = 'flex';
  checkUserRating();
});

// تأكيد التقييم
document.getElementById('confirmRating').addEventListener('click', async function() {
  const selectedRating = document.querySelector('.stars-container').getAttribute('data-selected');
  
  if (!selectedRating || selectedRating === '0') {
    alert('الرجاء اختيار تقييم أولاً!');
    return;
  }
  
  try {
    // حفظ التقييم في قاعدة البيانات
    await saveRating(parseInt(selectedRating));
    
    // حفظ حالة التقييم في localStorage
    localStorage.setItem('userRated', 'true');
    
    // إخفاء زر التقييم
    document.getElementById('rateButton').style.display = 'none';
    
    // إظهار رسالة الشكر وإخفاء زر التأكيد
    document.getElementById('ratedMessage').style.display = 'block';
    document.getElementById('confirmRating').style.display = 'none';
    
    // إغلاق نافذة التقييم بعد ثانيتين
    setTimeout(() => {
      document.getElementById('ratingOverlay').style.display = 'none';
    }, 2000);
    
  } catch (error) {
    console.error('Error confirming rating:', error);
    alert('حدث خطأ أثناء حفظ التقييم، الرجاء المحاولة لاحقاً');
  }
});

// دالة حفظ التقييم (كما هي مع بعض التحسينات)
async function saveRating(rating) {
  const userDocRef = doc(db, 'users', activeUser);
  const ratingsRef = collection(db, 'ratings');
  
  // تسجيل التقييم في مجموعة التقييمات
  await addDoc(ratingsRef, {
    username: activeUser,
    rating: rating,
    timestamp: new Date().toISOString()
  });
  
  // تحديث حالة المستخدم
  await updateDoc(userDocRef, {
    hasRated: true,
    lastRatingDate: new Date().toISOString()
  });
  
  // منح نقاط المكافأة إذا كانت التقييمات عالية
  if (rating >= 4) {
    const pointsEarned = rating === 5 ? 6000 : 10000;
    await updateDoc(userDocRef, {
      points: increment(pointsEarned)
    });
    showCustomAlert(pointsEarned, "Rating Reward");
  }
}

// التحقق من التقييم السابق عند فتح النافذة
async function checkUserRating() {
  try {
    const userDocRef = doc(db, 'users', activeUser);
    const userDoc = await getDoc(userDocRef);
    
    if (userDoc.exists() && userDoc.data().hasRated) {
      const ratingsRef = collection(db, 'ratings');
      const ratingQuery = query(ratingsRef, where("username", "==", activeUser));
      const querySnapshot = await getDocs(ratingQuery);
      
      querySnapshot.forEach((doc) => {
        const rating = doc.data().rating;
        
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.add('active');
          }
        });
        
        document.querySelector('.stars-container').setAttribute('data-selected', rating);
        document.getElementById('ratedMessage').style.display = 'block';
        document.getElementById('confirmRating').style.display = 'none';
      });
    }
  } catch (error) {
    console.error('Error checking user rating:', error);
  }
}

let lastMessageTimestamp = null;

// دالة لتنسيق عدد النقاط مع تأثير العد
function formatPoints(num, element) {
  if (!element) element = document.getElementById('points');
  
  const currentText = element.textContent.replace(/[^\d.]/g, '');
  const current = currentText ? parseFloat(currentText) : 0;
  const target = num;
  const duration = 800;
  const startTime = performance.now();
  
  if (target < current) {
    element.classList.add('counting-down');
    setTimeout(() => {
      element.classList.remove('counting-down');
    }, 800);
  }
  
  function updateCounter(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    let value;
    if (target > current) {
      value = current + (target - current) * progress;
    } else {
      value = current - (current - target) * progress;
    }
    
    let formattedValue;
    if (value >= 1_000_000_000_000) {
      formattedValue = (value / 1_000_000_000_000).toFixed(1).replace(/\.0$/, '') + 'T';
    } else if (value >= 1_000_000_000) {
      formattedValue = (value / 1_000_000_000).toFixed(1).replace(/\.0$/, '') + 'B';
    } else if (value >= 1_000_000) {
      formattedValue = (value / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
    } else if (value >= 1_000) {
      formattedValue = (value / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
    } else {
      // لعرض الكسور لـ Fall Tokens
      formattedValue = value.toFixed(5).replace(/\.?0+$/, '');
    }
    
    element.textContent = formattedValue;
    
    if (target > current) {
      element.classList.add('counting');
      setTimeout(() => {
        element.classList.remove('counting');
      }, 300);
    }
    
    if (progress < 1) {
      requestAnimationFrame(updateCounter);
    }
  }
  
  requestAnimationFrame(updateCounter);
} 

// دالة للاستماع للرسائل الجديدة
async function setupMessageListener() {
  const userDocRef = doc(db, 'users', activeUser);
  const messagesRef = collection(db, "messages");
  
  try {
    const userDoc = await getDoc(userDocRef);
    
    if (!userDoc.exists()) {
      console.warn('⛔ User doc does not exist while setting up message listener.');
      return; // أوقف التنفيذ حتى لا يسبب أخطاء
    }
    
    const lastSeenData = userDoc.data().lastSeenMessages || {};
    
    const messagesQuery = query(
      messagesRef,
      where("receiver", "==", activeUser),
      orderBy("timestamp", "desc")
    );
    
    const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const message = change.doc.data();
          
          const lastSeen = lastSeenData[message.sender];
          if (lastSeen && message.timestamp.toDate() <= new Date(lastSeen)) return;
          if (message.sender === activeUser) return;
          
          if (document.visibilityState !== 'visible') {
            showBrowserNotification(message.sender, message.message);
          }
          
          showMessageNotification(message.sender, message.message, message.type);
        }
      });
    });
    
    window.addEventListener('beforeunload', unsubscribe);
    
  } catch (error) {
    console.error("🔥 Error in setupMessageListener:", error);
  }
}

// دالة لعرض إشعارات المتصفح
// دالة لعرض إشعارات المتصفح
function showBrowserNotification(sender, message) {
    if (!("Notification" in window)) return;

    if (Notification.permission === "granted") {
        new Notification(`  new message from ${sender}`, {
            body: message.length > 50 ? message.substring(0, 50) + "..." : message,
            icon: "../icons/player-head-128-052ba.png"
        });
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification(`  new message from ${sender}`, {
                    body: message.length > 50 ? message.substring(0, 50) + "..." : message,
                    icon: "../icons/player-head-128-052ba.png"
                });
            }
        });
    }
}

// دالة لعرض إشعار التطبيق
function showMessageNotification(sender, message, type) {
  const notificationContainer = document.getElementById('notificationContainer');
  
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  let displayContent;
  if (type === "image") {
    // إذا كانت الصورة بصيغة Base64
    displayContent = `<img src="${message}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">`;
  } else {
    // إذا كانت رسالة نصية
    let displayMessage = message;
    if (displayMessage.length > 30) {
      displayMessage = displayMessage.substring(0, 30) + "...";
    }
    displayContent = `<div class="notification-message"><div class="img2"><img src="../icons/arrow_right.png"loading="lazy">${displayMessage}</div></div>`;
  }
  
  notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-title">⚪|<r>New message from:</r> ${sender}</div>
            <div style="width: 100%; height: 1px; background-color: white; margin: 10px 0;"></div>  
            ${displayContent}
        </div>
        <img src="../icons/player-head-128-052ba.png"loading="lazy" alt="${sender}">
    `;
  
  notification.addEventListener('click', () => {
    window.location.href = `chat_beta.html?user=${sender}`;
    notification.remove();
  });
  
  notificationContainer.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 9000);
}



// دالة الكتابة السلسة المعدلة
async function smoothTypeWriter(text, element, speed = 80) {
  element.innerHTML = "";
  element.classList.add('smooth-typing');
  
  // نستخدم حلقة for-of مع await لتحقيق تأثير أكثر سلاسة
  for (const char of text) {
    element.innerHTML += char;
    await new Promise(resolve => setTimeout(resolve, speed));
    
    // تأثير متغير للسرعة (أبطأ قليلاً عند المسافات)
    if (char === ' ') {
      await new Promise(resolve => setTimeout(resolve, speed * 1.5));
    }
  }
  
  element.classList.remove('smooth-typing');
  element.classList.add('typing-complete');
}

// دالة لإضافة النقاط
document.getElementById('whiteButton').addEventListener('click', async function () {
  const userDocRef = doc(db, 'users', activeUser);
  const userDoc = await getDoc(userDocRef);

  if (userDoc.exists()) {
    const user = userDoc.data();
    let earnedPoints;

    const chance = Math.random();
    if (chance <= 0.05) {
      earnedPoints = Math.floor(Math.random() * 11) + 50;
    } else {
      earnedPoints = Math.floor(Math.random() * 29) + 1;
    }

    // عرض التأثير قبل تحديث النقاط
    showPointsAddedEffect(earnedPoints);
    
    // تحديث النقاط في قاعدة البيانات
    await updateDoc(userDocRef, { 
      points: user.points + earnedPoints 
    });
    
    // تحديث العداد
    formatPoints(user.points + earnedPoints);
    
    // عرض التنبيه المخصص (اختياري)
  
  } else {
    alert('المستخدم غير موجود!');
  }
});

// دالة لعرض تأثير إضافة النقاط
function showPointsAddedEffect(points) {
  const pointsContainer = document.querySelector('.points');
  const addedElement = document.createElement('div');
  addedElement.className = 'points-added';
  addedElement.textContent = `+${points}`;
  
  // وضع العنصر في المكان المناسب
  addedElement.style.right = '0';
  addedElement.style.top = '0';
  
  pointsContainer.appendChild(addedElement);
  
  // إزالة العنصر بعد انتهاء الأنيميشن
  setTimeout(() => {
    addedElement.remove();
  }, 2000);
}
// دالة لإرسال النقاط
// اختيار العملة
const currencyToggle = document.getElementById('currencyToggle');
const currencyDropdown = document.getElementById('currencyDropdown');
const currencyIcon = document.getElementById('currencyIcon');
let selectedCurrency = 'points';

// إظهار/إخفاء قائمة العملات
currencyToggle.addEventListener('click', function(e) {
  e.stopPropagation();
  currencyDropdown.classList.toggle('show');
});

// اختيار عملة من القائمة
document.querySelectorAll('.currency-option').forEach(option => {
  option.addEventListener('click', function() {
    selectedCurrency = this.getAttribute('data-currency');
    currencyIcon.src = this.getAttribute('data-icon');
    currencyDropdown.classList.remove('show');
    
    // تحديث الخطوة بناءً على نوع العملة
    const amountInput = document.getElementById('sendPointsAmount');
    if (selectedCurrency === 'fallTokens') {
      amountInput.step = '0.00001';
      amountInput.min = '0.00001';
    } else {
      amountInput.step = '1';
      amountInput.min = '1';
    }
  });
});

// إغلاق القائمة عند النقر خارجها
window.addEventListener('click', function() {
  currencyDropdown.classList.remove('show');
});

// دالة لإرسال النقاط المعدلة
document.getElementById('redButton').addEventListener('click', async function() {
      const sender = activeUser;
      const receiver = document.getElementById('receiverUsername').value.trim();
      const amount = document.getElementById('sendPointsAmount').value.trim();
      
      if (!receiver || !amount) {
        alert('Please fill all fields!');
        return;
      }
      
      const amountValue = parseFloat(amount);
      
      if (isNaN(amountValue)) {
          alert('Please enter a valid amount!');
          return;
        }
        
        if (selectedCurrency === 'points' && !Number.isInteger(amountValue)) {
          alert('Coins must be whole numbers!');
          return;
        }
        
        if (amountValue <= 0) {
          alert('Amount must be greater than 0!');
          return;
        }
        
        if (selectedCurrency === 'fallTokens' && amountValue < 0.00001) {
          alert('Minimum Fall Tokens amount is 0.00001!');
          return;
        }
        
        if (receiver === sender) {
          alert('You cannot send to yourself!');
          return;
        }
        
        const senderDocRef = doc(db, 'users', sender);
        const receiverDocRef = doc(db, 'users', receiver);
        
        const [senderDocSnap, receiverDocSnap] = await Promise.all([
          getDoc(senderDocRef),
          getDoc(receiverDocRef)
        ]);
        
        if (!receiverDocSnap.exists()) {
          alert('Recipient username does not exist!');
          return;
        }
        
        const senderData = senderDocSnap.data();
        const senderBalance = senderData[selectedCurrency] || 0;
        
        if (senderBalance < amountValue) {
          const currencyName = selectedCurrency === 'points' ? 'Coins' : 'Fall Tokens';
          alert(`You don't have enough ${currencyName}!`);
          return;
        }
        
        // تنفيذ عملية التحويل
        try {
          const updateData = {};
          updateData[selectedCurrency] = increment(-amountValue);
          
          await updateDoc(senderDocRef, updateData);
          
          const receiverUpdateData = {};
          receiverUpdateData[selectedCurrency] = increment(amountValue);
          receiverUpdateData.notification = {
            from: sender,
            amount: amountValue,
            currency: selectedCurrency,
            read: false
          };
          
          await updateDoc(receiverDocRef, receiverUpdateData);
          
          // تحديث العرض للمستخدم
          const pointsElement = document.getElementById(selectedCurrency === 'points' ? 'points' : 'fallTokens');
          formatPoints(senderBalance - amountValue, pointsElement);
          
          const floatContainer = document.getElementById('points-float');
          const floatPoints = document.createElement('div');
          floatPoints.textContent = `-${amountValue.toLocaleString()}`;
          floatPoints.style.position = 'absolute';
          floatPoints.style.color = 'red';
          floatPoints.style.fontWeight = 'bold';
          floatPoints.style.fontSize = '1.2em';
          floatPoints.style.right = '0';
          floatPoints.style.top = '0';
          floatPoints.style.opacity = '1';
          floatPoints.style.transition = 'all 1s ease-out';
          floatPoints.style.pointerEvents = 'none';
          
          floatContainer.appendChild(floatPoints);
          
          setTimeout(() => {
            floatPoints.style.top = '-20px';
            floatPoints.style.opacity = '0';
          }, 50);
          
          setTimeout(() => {
            floatPoints.remove();
          }, 2500);
          
          const currencyName = selectedCurrency === 'points' ? 'Coins' : 'Fall Tokens';
          alert(`Successfully sent ${amountValue} ${currencyName} to ${receiver}!`);
          
          // إعادة تعيين الحقول
          document.getElementById('receiverUsername').value = '';
          document.getElementById('sendPointsAmount').value = '';
          
        } catch (error) {
          console.error('Error sending currency:', error);
          alert('An error occurred while sending. Please try again.');
        }
      });

// دالة لعرض التنبيه المخصص
function showCustomAlert(points, from = null) {
  const overlay = document.getElementById('customAlert');
  const box = document.getElementById('customAlertBox');
  const pointsDisplay = document.getElementById('customAlertPoints');

  if (from) {
    pointsDisplay.textContent = `${points} coins from ${from}`;
  } else {
    pointsDisplay.textContent = `${points} coins.`;
  }

  if (points <= 10) {
    box.style.backgroundColor = 'silver';
    box.style.boxShadow = '0 0 15px rgba(123, 123, 123, 1)';
    box.style.color = '#000';
  } else if (points <= 30) {
    box.style.backgroundColor = '#FFD700';
    box.style.boxShadow = '0 0 15px rgba(255, 205, 106, 1)';
    box.style.color = '#000';
  } else if (points <= 50) {
    box.style.backgroundColor = '#C50DD8';
    box.style.boxShadow = '0 0 15px rgba(255, 106, 255, 1)';
    box.style.color = '#fff';
  }

  overlay.style.display = 'flex';

  setTimeout(() => {
    overlay.style.display = 'none';
  }, 2000);
}

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', () => {
  getUserData();
  setupMessageListener();
  
  if ("Notification" in window) {
    Notification.requestPermission();
  }
  
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      lastMessageTimestamp = null;
    }
  });
});

// إدارة حالة المستخدم
async function setUserStatus(status) {
  const userDocRef = doc(db, 'users', activeUser);
  await updateDoc(userDocRef, {
    status: status,
    ...(status === 'offline' && { lastSeen: new Date().toISOString() })
  });
}

window.addEventListener('load', () => {
  document.querySelector('.header').style.opacity = '1';
  setUserStatus('online');
});

window.addEventListener('beforeunload', () => {
  setUserStatus('offline');
});

// إدارة قائمة أسماء المستخدمين
// إدارة قائمة أسماء المستخدمين - النسخة المحسنة
const receiverInput = document.getElementById('receiverUsername');
const dropdown = document.getElementById('usernameDropdown');

let usernames = [];
let dropdownOpen = false;

// فتح القائمة عند التركيز
receiverInput.addEventListener('focus', showDropdown);
receiverInput.addEventListener('click', showDropdown);

// إغلاق عند النقر بالخارج
document.addEventListener('click', (e) => {
  if (!receiverInput.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.style.display = 'none';
    dropdownOpen = false;
  }
});

// عند الكتابة: تصفية المستخدمين وعرضهم
receiverInput.addEventListener('input', () => {
  const term = receiverInput.value.toLowerCase();
  const filtered = usernames.filter(name => name.toLowerCase().includes(term));
  updateDropdown(filtered);
});

// دالة إظهار القائمة وتحميل المستخدمين عند أول مرة
async function showDropdown() {
  if (dropdownOpen) return;
  
  dropdownOpen = true;
  dropdown.style.display = 'block';
  dropdown.innerHTML = '<div class="dropdown-item">Loading users...</div>';
  
  try {
    if (usernames.length === 0) {
      const snapshot = await getDocs(collection(db, 'users'));
      usernames = snapshot.docs
        .map(doc => doc.id)
        .filter(name => name !== activeUser);
    }
    
    updateDropdown(usernames);
  } catch (err) {
    console.error('Error loading users:', err);
    dropdown.innerHTML = '<div class="dropdown-item">❌ Failed to load users</div>';
  }
}

// تحديث العناصر داخل القائمة
function updateDropdown(list) {
  dropdown.innerHTML = '';
  
  if (list.length === 0) {
    const noUser = document.createElement('div');
    noUser.className = 'dropdown-item';
    noUser.textContent = 'No users found';
    dropdown.appendChild(noUser);
    return;
  }
  
  list.slice(0, 100).forEach(username => {
    const item = document.createElement('div');
    item.className = 'dropdown-item';
    item.textContent = username;
    item.addEventListener('click', () => {
      receiverInput.value = username;
      dropdown.style.display = 'none';
      dropdownOpen = false;
    });
    dropdown.appendChild(item);
  });
}
</script>

<script>
  // تسجيل الخروج
// استبدال الكود القديم بهذا الكود
document.getElementById("menuButton").addEventListener('click', function(e) {
  e.stopPropagation(); // منع انتشار الحدث
  const dropdown = document.getElementById('logoutDropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
});

// إغلاق القائمة عند النقر خارجها
document.addEventListener('click', function(e) {
  if (!e.target.closest('.header')) {
    document.getElementById('logoutDropdown').style.display = 'none';
  }
});

// زر تسجيل الخروج
document.getElementById('confirmLogout').addEventListener('click', function() {
  localStorage.removeItem('activeUser');
  window.location.href = 'login.html';
});

// زر الإعدادات (يمكنك إضافة وظيفته لاحقاً)
document.getElementById('settingsButton').addEventListener('click', function() {
  window.location.href = 'Settings.html';
  document.getElementById('logoutDropdown').style.display = 'none';
});

// زر الإلغاء
document.getElementById('cancelLogout').addEventListener('click', function() {
  document.getElementById('logoutDropdown').style.display = 'none';
});

</script>
    <script>
window.addEventListener('scroll', function() {
  const header = document.querySelector('.sticky-header');
  if (window.scrollY > 0) {
    header.classList.add('sticky');
  } else {
    header.classList.remove('sticky');
  }
});
</script>
</body>
</html>
