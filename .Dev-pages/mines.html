<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mines</title>
  <link rel="icon" type="image/x-icon" href="../web/mcco-logo.png" />
  <link rel="stylesheet" href="../style/main.css" />
  <style>
    .balance-bar { 
      border-radius: 8px; background-color: #2a2a2a; border: 2px solid #313131D1;
      margin:10px; padding:12px; display:flex; justify-content:center; gap:25px; flex-wrap:wrap;
    }
    .bal { display:flex; align-items:center; gap:10px; }

    .plinko-container { padding:10px; display:flex; flex-direction:column; align-items:center; }

    .controls {
      width: 90%; max-width: 490px; padding:18px; border-radius: 8px;
      background-color: #2a2a2a; border: 2px solid #313131D1; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .bet-inputs { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-bottom:15px; }
    input, select, button {
      padding:12px; background:#333; border:none; border-radius:10px; color:#ffffff; font-size:16px; text-align:center;
    }
    input { width:140px; }

    #grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      max-width: 420px;
      margin: 20px auto;
    }
    .cell {
      width: 70px; height: 70px;
      background: #333;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 36px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .cell.revealed { cursor: default; transform: scale(0.95); }
    .cell.diamond { background: #1b5e20; box-shadow: 0 0 30px #4CAF50; }
    .cell.diamond::after { content: "ğŸ’"; }
    .cell.bomb { background: #7f0000; box-shadow: 0 0 30px #f44336; }
    .cell.bomb::after { content: "ğŸ’£"; animation: explode 0.6s forwards; }

    @keyframes explode {
      0% { transform: scale(1); }
      50% { transform: scale(1.6); }
      100% { transform: scale(1); }
    }

    .current-multiplier {
      font-size: 42px; font-weight: bold; color: #4CAF50; margin: 15px 0;
    }

    .cashout-btn {
      background: linear-gradient(45deg, #4CAF50, #66BB6A);
      padding: 16px 50px; font-size: 20px; font-weight: bold; border-radius: 50px;
      margin-top: 10px; cursor: pointer;
    }
    .cashout-btn:disabled { background: #555; cursor: not-allowed; }

    .stats { 
      margin-top:10px; padding:15px; background:#222; border-radius:12px;
      width:90%; max-width:420px; text-align:center; font-size:18px; color:#fff;
    }
    .profit { color:#4CAF50; font-weight:bold; }
    .loss { color:#f44336; font-weight:bold; }

    .toast { 
      position:fixed; top:100px; right:-350px; z-index:9999; padding:16px 30px;
      border-radius:12px; font-size:17px; background:#333; color:#fff;
      box-shadow:0 6px 20px rgba(0,0,0,0.6); transition:right 0.6s ease; 
    }
    .toast.show { right:20px; }
    .toast.win { background:#1b5e20; }
    .toast.lose { background:#7f0000; }
  </style>
</head>
<body>

  <div class="header">
    <button class="back" onclick="history.back()"><</button>
    Mines
  </div>

  <div class="balance-bar">
    <div class="bal"><img src="../icons/coinss_gif.gif" height="22"> <span id="coins" class="points"><img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span></div>
    <div class="bal"><img src="../icons/fall_token.png" height="22"> <span id="tokens" class="fallTokens"><img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span></div>
  </div>

  <div class="plinko-container">
    <div class="controls">
      <div class="bet-inputs">
        <input type="number" id="betAmount" value="500" min="10" placeholder="Bet Amount" />
        <select id="currency">
          <option value="points">Coins</option>
          <option value="fallTokens">Fall Tokens</option>
        </select>
      </div>
      <button id="startBtn" class="greenButton">Start Game!</button>

      <div id="gameArea" style="display:none; text-align:center;">
        <div class="current-multiplier" id="multiplier">1.00x</div>
        <div id="grid"></div>
        <button id="cashoutBtn" class="cashout-btn" disabled>Cashout</button>
      </div>
    </div>

    <div class="stats">
      Session Profit: <span id="sessionProfit" class="profit">+0</span>
    </div>
  </div>

  <div id="toast" class="toast"></div>
<script>
  (function() {
    const PASSWORD = "12345678"; // ØºÙŠÙ‘Ø±Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ù„ÙƒÙ„Ù…Ø© 
    
    // Ø§Ø®ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚
    document.documentElement.style.display = "none";
    
    const tryAuth = () => {
      const answer = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©:");
      if (answer === null) {
        // user cancelled -> Ø§Ø¹Ø¯ Ø§Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ø£ØºÙ„Ù‚
        document.documentElement.innerHTML = "<p>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙÙˆÙŠØ¶.</p>";
        document.documentElement.style.display = "block";
        return;
      }
      if (answer === PASSWORD) {
        // Ù†Ø§Ø¬Ø­
        sessionStorage.setItem("authed", "1"); // ØªØ°ÙƒØ± Ø§Ù„Ø¬Ù„Ø³Ø©
        document.documentElement.style.display = "block";
        alert("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ø±Ø­Ø¨Ø§Ù‹!");
      } else {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©.");
        tryAuth(); // Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
      }
    };
    
    // Ø§Ø°Ø§ Ø³Ø¨Ù‚ ÙˆØªØ­Ù‚Ù‚Ù†Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ø§ Ù†Ø·Ù„Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    if (sessionStorage.getItem("authed") === "1") {
      document.documentElement.style.display = "block";
    } else {
      tryAuth();
    }
  })();
</script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBf-HKpI4G5p6E0xP1OHGLxtDTGwE_0gg0",
      authDomain: "minecraft-community-4fd3d.firebaseapp.com",
      projectId: "minecraft-community-4fd3d",
      storageBucket: "minecraft-community-4fd3d.appspot.com",
      messagingSenderId: "550140131027",
      appId: "1:550140131027:web:a5186726cf5372e138c626"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const user = localStorage.getItem("activeUser");
    if (!user) location.href = "login-page.html";

    const MINES_COUNT = 5;  // Ø«Ø§Ø¨Øª 5 Ø£Ù„ØºØ§Ù… Ø¯Ø§ÙŠÙ…Ù‹Ø§
    let balance = { points: 0, fallTokens: 0 };
    let sessionProfit = parseInt(localStorage.getItem("minesSessionProfit_v2") || "0");
    let gameActive = false;
    let revealed = 0;
    let betAmount, currency;
    let bombs = [];
    const grid = document.getElementById("grid");

    const formatNumber = n => n >= 1e9 ? (n/1e9).toFixed(1)+'B' : n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'k' : n;

    const updateDisplay = () => {
      document.getElementById("coins").textContent = formatNumber(balance.points);
      document.getElementById("tokens").textContent = formatNumber(balance.fallTokens);
      const el = document.getElementById("sessionProfit");
      el.textContent = (sessionProfit >= 0 ? "+" : "") + formatNumber(sessionProfit);
      el.className = sessionProfit >= 0 ? "profit" : "loss";
    };

    const showToast = (text, isWin = false) => {
      const t = document.getElementById("toast");
      t.textContent = text;
      t.className = `toast show ${isWin ? "win" : "lose"}`;
      setTimeout(() => t.classList.remove("show"), 3500);
    };

    const loadBalance = async () => {
      const snap = await getDoc(doc(db, "users", user));
      if (snap.exists()) {
        balance.points = snap.data().points || 0;
        balance.fallTokens = snap.data().fallTokens || 0;
        updateDisplay();
      }
    };

    // â˜…â˜…â˜… Ù‡Ù†Ø§ ØªØºÙŠØ± Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ 100% â˜…â˜…â˜…
    const WIN_CHANCE_PERCENT = 48;  // 48% ÙØ±ØµØ© ÙÙˆØ² (ØºÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¯Ù‡ Ø¨Ø³ Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ²ÙˆØ¯ Ø£Ùˆ ØªÙ‚Ù„Ù„)

    const getMultiplier = (opened) => {
      const safe = 25 - MINES_COUNT;
      return (99 / (safe - opened + 1)).toFixed(2);
    };

    const startGame = async () => {
      betAmount = parseInt(document.getElementById("betAmount").value) || 0;
      currency = document.getElementById("currency").value;

      if (betAmount < 10) return showToast("Minimum bet 10");
      if (balance[currency] < betAmount) return showToast("Not enough balance!");

      balance[currency] -= betAmount;
      await updateDoc(doc(db, "users", user), { [currency]: balance[currency] });
      updateDisplay();

      gameActive = true;
      revealed = 0;
      bombs = [];
      document.getElementById("gameArea").style.display = "block";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("cashoutBtn").disabled = false;
      document.getElementById("multiplier").textContent = "1.00x";

      // ØªÙˆÙ„ÙŠØ¯ 5 Ø£Ù„ØºØ§Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ
      while (bombs.length < MINES_COUNT) {
        const pos = Math.floor(Math.random() * 25);
        if (!bombs.includes(pos)) bombs.push(pos);
      }

      grid.innerHTML = "";
      for (let i = 0; i < 25; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.index = i;
        cell.onclick = () => revealCell(cell);
        grid.appendChild(cell);
      }
    };

    const revealCell = (cell) => {
      if (!gameActive || cell.classList.contains("revealed")) return;
      cell.classList.add("revealed");

      const idx = parseInt(cell.dataset.index);
      if (bombs.includes(idx)) {
        cell.classList.add("bomb");
        gameActive = false;
        document.getElementById("cashoutBtn").disabled = true;
        showToast(`Lost ${formatNumber(betAmount)}`, false);
        revealAllBombs();
        setTimeout(resetGame, 2500);
      } else {
        cell.classList.add("diamond");
        revealed++;
        const mult = getMultiplier(revealed);
        document.getElementById("multiplier").textContent = mult + "x";

        // ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙˆØ² Ø£Ùˆ Ø§Ù„Ø®Ø³Ø§Ø±Ø©
        if (Math.random() * 100 >= WIN_CHANCE_PERCENT) {
          // Ù†Ø®Ù„ÙŠÙ‡ ÙŠØ®Ø³Ø± ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¬Ø§ÙŠØ© (Ù†Ø­Ø· Ù„ØºÙ… ÙÙŠ Ø®Ù„ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©)
          const remaining = [];
          for (let i = 0; i < 25; i++) {
            if (!grid.children[i].classList.contains("revealed")) remaining.push(i);
          }
          if (remaining.length > 0) {
            const fakeIdx = remaining[Math.floor(Math.random() * remaining.length)];
            bombs.push(fakeIdx);  // Ù†Ø¶ÙŠÙ Ù„ØºÙ… Ø¬Ø¯ÙŠØ¯ Ø¹Ø´Ø§Ù† ÙŠØ®Ø³Ø± Ù„Ù…Ø§ ÙŠØ¶ØºØ·
          }
        }
      }
    };

    const cashout = async () => {
      if (!gameActive) return;
      const mult = getMultiplier(revealed);
      const win = Math.floor(betAmount * mult);
      const profit = win - betAmount;

      balance[currency] += win;
      await updateDoc(doc(db, "users", user), { [currency]: balance[currency] });
      sessionProfit += profit;
      localStorage.setItem("minesSessionProfit_v2", sessionProfit);
      updateDisplay();

      showToast("WON +" + formatNumber(profit) + " Ã—" + mult + "!", true);
      gameActive = false;
      document.getElementById("cashoutBtn").disabled = true;
      setTimeout(resetGame, 2000);
    };

    const revealAllBombs = () => {
      Array.from(grid.children).forEach((c, i) => {
        if (bombs.includes(i)) {
          c.classList.add("revealed", "bomb");
        }
      });
    };

    const resetGame = () => {
      document.getElementById("gameArea").style.display = "none";
      document.getElementById("startBtn").disabled = false;
    };

    document.getElementById("startBtn").onclick = startGame;
    document.getElementById("cashoutBtn").onclick = cashout;

    loadBalance();
  </script>
  
</body>
</html>