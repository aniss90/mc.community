<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plinko - Final Perfect Version</title>
  <link rel="icon" type="image/x-icon" href="../web/mcco-logo.png" />
  <link rel="stylesheet" href="../style/main.css" />
  <style>


    body { margin:0; padding:0; background:#1a1a1a; color:#fff; font-family:minecraft-five; overflow:hidden; }

    .balance-bar { 
   border-radius: 8px;
background-color: #2a2a2a;
border: 2px solid #313131D1;
color: #ffffff;
outline: none;
transition: all 0.3s ease;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
margin:10px; padding:12px; display:flex; justify-content:center; gap:25px; flex-wrap:wrap;  }
    .bal { display:flex; align-items:center; gap:10px; }

    .plinko-container { padding:10px; display:flex; flex-direction:column; align-items:center; }

    .controls {
      width: 90%;
      max-width: 490px;
      padding:18px; border-radius: 8px;
background-color: #2a2a2a;
color: #ffffff;
outline: none;
border: 2px solid #313131D1;
transition: all 0.3s ease;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);}
    .bet-inputs { display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-bottom:15px; }
    input, select { padding:12px; background:#333; border:none; border-radius:10px; color:white; font-size:16px; text-align:center; }
    input { width:140px; }


    canvas { border-radius: 8px;
background-color: #2a2a2a;
color: #ffffff;
outline: none;
transition: all 0.3s ease;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);border: 2px solid #313131D1; margin:10px 0; }

    .multipliers { display:grid; grid-template-columns:repeat(9,1fr); gap:7px; width:90%; max-width:420px; margin-top:10px; }
    .slot { background:#333; padding:12px 4px; border-radius:10px; font-size:14px; text-align:center; font-weight:bold; transition: all 0.3s; }
    .slot.high { background:#1b5e20; }
    .slot.glow { animation: glow 1.5s infinite alternate; box-shadow:0 0 30px #0f0 !important; }
    @keyframes glow { from { box-shadow:0 0 10px #0f0; } to { box-shadow:0 0 40px #0f0; } }

    .stats { margin-top:10px; padding:15px; background:#222; border-radius:12px; width:90%; max-width:420px; text-align:center; font-size:18px; }
    .profit { color:#4CAF50; font-weight:bold; }
    .loss { color:#f44336; font-weight:bold; }

    .toast { position:fixed; top:100px; right:-350px; z-index:9999; padding:16px 30px; border-radius:12px; font-size:17px; background:#333; color:white; box-shadow:0 6px 20px rgba(0,0,0,0.6); transition:right 0.6s ease; }
    .toast.show { right:20px; }
    .toast.win { background:#1b5e20; }
    .toast.lose { background:#7f0000; }
    
  </style>
</head>
<body>

  <div class="header">
    <button class="back" onclick="history.back()"><</button>
    Plinko
  </div>

  <div class="balance-bar">
    <div class="bal"><img src="../icons/coinss_gif.gif" height="22"> <span id="coins" class="points"><img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span></div>
    <div class="bal"><img src="../icons/fall_token.png" height="22"> <span id="tokens" class="fallTokens"><img class="lodinimg" src="../icons/loading_spinner.gif" height="13" /></span></div>
  </div>

  <div class="plinko-container">
    <div class="controls">
      <div class="bet-inputs">
        <input type="number" id="betAmount" value="500" min="10" placeholder="Bet Amount" />
        <select id="currency">
          <option value="points">Coins</option>
          <option value="fallTokens">Fall Tokens</option>
        </select>
      </div>
      <button id="dropBtn" class="greenButton">Drop Ball!</button>
    </div>

    <canvas id="canvas" width="420" height="620"></canvas>

    <div class="multipliers" id="multipliers">
      <div class="slot low">0×</div>
      <div class="slot low">0.3×</div>
      <div class="slot med">0.8×</div>
      <div class="slot med">1.2×</div>
      <div class="slot high">5×</div>
      <div class="slot med">1.2×</div>
      <div class="slot med">0.8×</div>
      <div class="slot low">0.3×</div>
      <div class="slot low">0×</div>
    </div>

    <div class="stats">
      Session Profit: <span id="sessionProfit" class="profit">+0</span>
    </div>
  </div>

  <div id="toast" class="toast"></div>
<script>
  (function() {
    const PASSWORD = "12345678"; // غيّرها هنا للكلمة 
    
    // اخفي المحتوى حتى يتم التحقق
    document.documentElement.style.display = "none";
    
    const tryAuth = () => {
      const answer = prompt("أدخل كلمة السر لاستخدام هذه الصفحة:");
      if (answer === null) {
        // user cancelled -> اعد اظهار الصفحة فارغة أو أغلق
        document.documentElement.innerHTML = "<p>لم يتم التفويض.</p>";
        document.documentElement.style.display = "block";
        return;
      }
      if (answer === PASSWORD) {
        // ناجح
        sessionStorage.setItem("authed", "1"); // تذكر الجلسة
        document.documentElement.style.display = "block";
        alert("تم الدخول - مرحباً!");
      } else {
        alert("كلمة السر خاطئة.");
        tryAuth(); // جرّب مرة أخرى
      }
    };
    
    // اذا سبق وتحققنا في نفس الجلسة لا نطلب الكلمة مرة أخرى
    if (sessionStorage.getItem("authed") === "1") {
      document.documentElement.style.display = "block";
    } else {
      tryAuth();
    }
  })();
</script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBf-HKpI4G5p6E0xP1OHGLxtDTGwE_0gg0",
      authDomain: "minecraft-community-4fd3d.firebaseapp.com",
      projectId: "minecraft-community-4fd3d",
      storageBucket: "minecraft-community-4fd3d.appspot.com",
      messagingSenderId: "550140131027",
      appId: "1:550140131027:web:a5186726cf5372e138c626"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = localStorage.getItem("activeUser");
    if (!user) location.href = "login-page.html";

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const W = canvas.width;
    const H = canvas.height;

    const ROWS = 11;
    const PEG_RADIUS =  6;
    const BALL_RADIUS = 11;
    const COL_SPACING = 42;
    const ROW_SPACING = 47;
    const FUNNEL_Y = 60;
    const PEG_START_Y = 170;
    const BOTTOM_Y = H - 70;

    const MULTIPLIERS = [0, 0.3, 0.8, 1.2, 5, 1.2, 0.8, 0.3, 0];
    const SLOTS_COUNT = MULTIPLIERS.length;

    let balance = { points: 0, fallTokens: 0 };
    let sessionProfit = parseInt(localStorage.getItem("plinkoSessionProfit_v2") || "0");
    let balls = [];

    const formatNumber = (n) => {
      if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
      if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n/1e3).toFixed(1) + 'k';
      return n.toString();
    };

    const updateDisplay = () => {
      document.getElementById("coins").textContent = formatNumber(balance.points);
      document.getElementById("tokens").textContent = formatNumber(balance.fallTokens);

      const profitEl = document.getElementById("sessionProfit");
      profitEl.textContent = (sessionProfit >= 0 ? "+" : "") + formatNumber(sessionProfit);
      profitEl.className = sessionProfit >= 0 ? "profit" : "loss";
    };

    const showToast = (message, isError = false) => {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = `toast show ${isError ? "" : (message.includes("WON") ? "win" : "lose")}`;
      setTimeout(() => toast.classList.remove("show"), 3000);
    };

    const loadBalance = async () => {
      const snap = await getDoc(doc(db, "users", user));
      if (snap.exists()) {
        balance.points = snap.data().points || 0;
        balance.fallTokens = snap.data().fallTokens || 0;
        updateDisplay();
      }
    };

    const drawFunnel = () => {
      ctx.strokeStyle = "#777";
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(W/2 - 70, FUNNEL_Y);
      ctx.lineTo(W/2 - 18, FUNNEL_Y + 80);
      ctx.lineTo(W/2 + 18, FUNNEL_Y + 80);
      ctx.lineTo(W/2 + 70, FUNNEL_Y);
      ctx.stroke();

      ctx.fillStyle = "#444";
      ctx.fillRect(W/2 - 75, FUNNEL_Y - 12, 150, 24);
    };

    const drawPegs = () => {
      ctx.fillStyle = "#ccc";
      for (let r = 0; r < ROWS; r++) {
        const cols = r + 3;
        const offsetX = (W - (cols - 1) * COL_SPACING) / 2;
        for (let c = 0; c < cols; c++) {
          const x = offsetX + c * COL_SPACING;
          const y = PEG_START_Y + r * ROW_SPACING;
          ctx.beginPath();
          ctx.arc(x, y, PEG_RADIUS, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    };

    class Ball {
      constructor(amount, currency) {
        this.amount = amount;
        this.currency = currency;
        this.color = currency === "points" ? "#ffeb3b" : "#ff9800";

        const deviation = (Math.random() - 0.5) * 30;
        this.x = W / 2 + deviation;
        this.y = FUNNEL_Y - 30;
        this.vx = (Math.random() - 0.5) * 1.5;
        this.vy = 0;
        this.settled = false;
      }

      update() {
        if (this.settled) return;

        this.vy += 0.38;
        if (this.vy < 1.2) this.vy = 1.2;

        // Collision with pegs
        for (let r = 0; r < ROWS; r++) {
          const cols = r + 3;
          const offsetX = (W - (cols - 1) * COL_SPACING) / 2;
          for (let c = 0; c < cols; c++) {
            const px = offsetX + c * COL_SPACING;
            const py = PEG_START_Y + r * ROW_SPACING;
            const dx = this.x - px;
            const dy = this.y - py;
            const dist = Math.hypot(dx, dy);

            if (dist < BALL_RADIUS + PEG_RADIUS + 2) {
              let angle = Math.atan2(dy, dx);
              angle += (Math.random() > 0.5 ? 1 : -1) * (0.4 + Math.random() * 0.4);
              const speed = Math.hypot(this.vx, this.vy) * 0.82;

              this.vx = Math.cos(angle) * speed;
              this.vy = Math.sin(angle) * speed * 1.1;

              const overlap = (BALL_RADIUS + PEG_RADIUS) - dist + 1;
              this.x += Math.cos(angle) * overlap;
              this.y += Math.sin(angle) * overlap;
            }
          }
        }

        this.x += this.vx;
        this.y += this.vy;

        if (this.y > BOTTOM_Y) {
          this.y = BOTTOM_Y;
          this.vy = 0;
          this.vx *= 0.5;

          if (Math.abs(this.vx) < 0.3) {
            this.settle();
          }
        }
      }

      settle() {
        if (this.settled) return;
        this.settled = true;

        const slotIndex = Math.floor((this.x / W) * SLOTS_COUNT);
        const slot = Math.max(0, Math.min(SLOTS_COUNT - 1, slotIndex));
        const multiplier = MULTIPLIERS[slot];
        const winAmount = Math.floor(this.amount * multiplier);
        const profit = winAmount - this.amount;

        const field = this.currency === "points" ? "points" : "fallTokens";
        balance[this.currency] += profit;
        updateDoc(doc(db, "users", user), { [field]: balance[this.currency] });

        sessionProfit += profit;
        localStorage.setItem("plinkoSessionProfit_v2", sessionProfit);
        updateDisplay();

        let msg;
        if (profit > 0) msg = `WON +${formatNumber(profit)}!`;
        else if (profit < 0) msg = `LOST ${formatNumber(-profit)}`;
        else msg = "Returned";

        showToast(msg);

        if (multiplier === 5) {
          document.querySelectorAll('.slot')[4].classList.add('glow');
          setTimeout(() => document.querySelectorAll('.slot')[4].classList.remove('glow'), 3000);
        }
      }

      draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.vx * 0.15);

        ctx.fillStyle = this.color;
        ctx.shadowBlur = 20;
        ctx.shadowColor = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, BALL_RADIUS, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#000";
        ctx.font = "bold 10px minecraft";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(this.amount, 0, 0);

        ctx.restore();
      }
    }

    const animate = () => {
      ctx.clearRect(0, 0, W, H);
      drawFunnel();
      drawPegs();

      balls = balls.filter(ball => {
        ball.update();
        ball.draw();
        return !ball.settled;
      });

      requestAnimationFrame(animate);
    };

    document.getElementById("dropBtn").onclick = async () => {
      const amount = parseInt(document.getElementById("betAmount").value) || 0;
      const currency = document.getElementById("currency").value;

      if (amount < 1) {
        showToast("Minimum bet is 10", true);
        return;
      }
      if (balance[currency] < amount) {
        showToast("Not enough balance!", true);
        return;
      }

      balance[currency] -= amount;
      await updateDoc(doc(db, "users", user), { [currency]: balance[currency] });
      updateDisplay();

      balls.push(new Ball(amount, currency));
    };

    await loadBalance();
    animate();
  </script>
</body>
</html>